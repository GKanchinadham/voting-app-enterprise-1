# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                    OPERATIONS: DEPLOYMENT LANDSCAPE REPORT                    â•‘
# â•‘                                                                                â•‘
# â•‘  Generates a comprehensive deployment landscape showing:                       â•‘
# â•‘  â€¢ DEV and QA environment status                                               â•‘
# â•‘  â€¢ Current builds/versions                                                     â•‘
# â•‘  â€¢ Canary deployment progress                                                  â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ“Š Ops: Deployment Landscape"

on:
  workflow_dispatch:
    inputs:
      slack_notify:
        description: 'Send report to Slack'
        required: false
        type: boolean
        default: true
  schedule:
    - cron: '0 9 * * *'

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: read
  id-token: write

jobs:
  generate-report:
    name: "ğŸ“Š Generate Report"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          sudo apt-get update && sudo apt-get install -y jq

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # REPORT HEADER
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Generate Header
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'HEADER'
          # ğŸŒ Deployment Landscape
          
          **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Application:** voting-app
          
          ---
          
          ## ğŸ”„ Deployment Pipeline
          
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                    CI/CD PIPELINE FLOW                      â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                             â”‚
          â”‚   ğŸ“¦ Build    ğŸ”’ Security   âœ… Quality    ğŸš€ Deploy        â”‚
          â”‚      â”‚            â”‚            â”‚             â”‚             â”‚
          â”‚      â–¼            â–¼            â–¼             â–¼             â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”         â”‚
          â”‚   â”‚Buildâ”‚â”€â”€â”€â–ºâ”‚ Grype   â”‚â”€â”€â–ºâ”‚ Gates â”‚â”€â”€â”€â–ºâ”‚  DEV  â”‚         â”‚
          â”‚   â”‚ All â”‚    â”‚  Scan   â”‚   â”‚       â”‚    â”‚       â”‚         â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”˜         â”‚
          â”‚                                             â”‚              â”‚
          â”‚                            ğŸš¦ Slack        â”‚              â”‚
          â”‚                             Approval â—„â”€â”€â”€â”€â”€â”˜              â”‚
          â”‚                                â”‚                          â”‚
          â”‚                                â–¼                          â”‚
          â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”                       â”‚
          â”‚                           â”‚  QA   â”‚ ğŸ¤ Canary             â”‚
          â”‚                           â”‚       â”‚ 10%â†’30%â†’60%â†’100%      â”‚
          â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
          â”‚                                                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```
          
          ---
          
          HEADER

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ENVIRONMENT STATUS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Collect Environment Status
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          REPO_URL="https://github.com/${{ github.repository }}"
          
          echo "## ğŸ“Š Environment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status | Health | Sync | Current Build | Last Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|--------|------|---------------|---------------|" >> $GITHUB_STEP_SUMMARY
          
          # Create JSON for Slack
          echo '{"environments":[' > /tmp/env_data.json
          FIRST=true
          
          for ENV in dev qa; do
            APP_NAME="${{ env.APP_NAME }}-${ENV}"
            
            if kubectl get application "${APP_NAME}" -n argocd &>/dev/null; then
              SYNC_STATUS=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
              HEALTH_STATUS=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
              
              LAST_SYNC=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.operationState.finishedAt}' 2>/dev/null || echo "")
              if [ -n "$LAST_SYNC" ]; then
                LAST_SYNC_FORMATTED=$(date -d "$LAST_SYNC" '+%Y-%m-%d %H:%M' 2>/dev/null || echo "$LAST_SYNC")
              else
                LAST_SYNC_FORMATTED="Never"
              fi
              
              # Get image tag
              OVERLAY_PATH=".opsera-voting-app/k8s/overlays/${ENV}/kustomization.yaml"
              if [ -f "$OVERLAY_PATH" ]; then
                IMAGE_TAG=$(grep -A2 "name: vote$" "$OVERLAY_PATH" | grep "newTag" | awk -F': ' '{print $2}' | tr -d ' "' || echo "N/A")
                COMMIT_HASH=$(echo "$IMAGE_TAG" | cut -d'-' -f1)
              else
                IMAGE_TAG="N/A"
                COMMIT_HASH=""
              fi
              
              # Status emojis
              case "$HEALTH_STATUS" in
                "Healthy") HEALTH_EMOJI="ğŸŸ¢" ;;
                "Progressing") HEALTH_EMOJI="ğŸ”µ" ;;
                "Degraded") HEALTH_EMOJI="ğŸ”´" ;;
                *) HEALTH_EMOJI="âšª" ;;
              esac
              
              case "$SYNC_STATUS" in
                "Synced") SYNC_EMOJI="âœ…" ;;
                "OutOfSync") SYNC_EMOJI="âš ï¸" ;;
                *) SYNC_EMOJI="â“" ;;
              esac
              
              # Environment label
              if [ "$ENV" = "qa" ]; then
                ENV_LABEL="**QA** ğŸ¤"
              else
                ENV_LABEL="**DEV**"
              fi
              
              # Build link
              if [ -n "$COMMIT_HASH" ] && [ "$COMMIT_HASH" != "N/A" ]; then
                BUILD_LINK="[\`${IMAGE_TAG:0:15}\`](${REPO_URL}/commit/${COMMIT_HASH})"
              else
                BUILD_LINK="\`${IMAGE_TAG}\`"
              fi
              
              echo "| ${ENV_LABEL} | ${HEALTH_EMOJI} ${HEALTH_STATUS} | ${HEALTH_EMOJI} | ${SYNC_EMOJI} ${SYNC_STATUS} | ${BUILD_LINK} | ${LAST_SYNC_FORMATTED} |" >> $GITHUB_STEP_SUMMARY
              
              # JSON for Slack
              [ "$FIRST" = "true" ] && FIRST=false || echo "," >> /tmp/env_data.json
              cat >> /tmp/env_data.json << ENVJSON
              {"name": "${ENV}", "health": "${HEALTH_STATUS}", "sync": "${SYNC_STATUS}", "build": "${IMAGE_TAG}", "lastDeployed": "${LAST_SYNC_FORMATTED}"}
          ENVJSON
            fi
          done
          
          echo ']}' >> /tmp/env_data.json
          echo "" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BUILD VERSION MATRIX
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Build Version Matrix
        run: |
          REPO_URL="https://github.com/${{ github.repository }}"
          
          echo "## ğŸ·ï¸ Build Version Matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | DEV | QA |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|-----|" >> $GITHUB_STEP_SUMMARY
          
          for SERVICE in vote result worker; do
            ROW="| **${SERVICE}** |"
            
            for ENV in dev qa; do
              OVERLAY_PATH=".opsera-voting-app/k8s/overlays/${ENV}/kustomization.yaml"
              if [ -f "$OVERLAY_PATH" ]; then
                TAG=$(grep -A2 "name: ${SERVICE}$" "$OVERLAY_PATH" | grep "newTag" | awk -F': ' '{print $2}' | tr -d ' "' || echo "")
                if [ -n "$TAG" ] && [ "$TAG" != "-" ]; then
                  COMMIT_HASH=$(echo "$TAG" | cut -d'-' -f1)
                  SHORT_TAG=$(echo "$TAG" | cut -c1-15)
                  ROW="${ROW} [\`${SHORT_TAG}\`](${REPO_URL}/commit/${COMMIT_HASH}) |"
                else
                  ROW="${ROW} - |"
                fi
              else
                ROW="${ROW} - |"
              fi
            done
            
            echo "$ROW" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CANARY STATUS (QA)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Canary Status
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          NAMESPACE="${{ env.APP_NAME }}-qa"
          
          if ! kubectl get namespace "${NAMESPACE}" &>/dev/null; then
            echo "## ğŸ¤ Canary Status" >> $GITHUB_STEP_SUMMARY
            echo "QA namespace not found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "## ğŸ¤ Canary Deployment Status (QA)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Summary table
          echo "### Rollout Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Rollout | Phase | Step | Traffic Split |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|------|---------------|" >> $GITHUB_STEP_SUMMARY
          
          for ROLLOUT in vote-rollout result-rollout; do
            if kubectl get rollout "${ROLLOUT}" -n "${NAMESPACE}" &>/dev/null; then
              ROLLOUT_JSON=$(kubectl get rollout "${ROLLOUT}" -n "${NAMESPACE}" -o json 2>/dev/null)
              
              PHASE=$(echo "$ROLLOUT_JSON" | jq -r '.status.phase // "Unknown"')
              STEP_INDEX=$(echo "$ROLLOUT_JSON" | jq -r '.status.currentStepIndex // 0')
              TOTAL_STEPS=$(echo "$ROLLOUT_JSON" | jq -r '.spec.strategy.canary.steps | length')
              
              CANARY_WEIGHT_RAW=$(echo "$ROLLOUT_JSON" | jq -r 'if .status.canary.weights.canary then .status.canary.weights.canary else 0 end')
              [[ "$CANARY_WEIGHT_RAW" =~ ^[0-9]+$ ]] && CANARY_WEIGHT=$CANARY_WEIGHT_RAW || CANARY_WEIGHT=0
              STABLE_WEIGHT=$((100 - CANARY_WEIGHT))
              
              case "$PHASE" in
                "Healthy") PHASE_EMOJI="ğŸŸ¢" ;;
                "Progressing") PHASE_EMOJI="ğŸ”µ" ;;
                "Paused") PHASE_EMOJI="â¸ï¸" ;;
                "Degraded") PHASE_EMOJI="ğŸ”´" ;;
                *) PHASE_EMOJI="âšª" ;;
              esac
              
              echo "| ${ROLLOUT} | ${PHASE_EMOJI} ${PHASE} | ${STEP_INDEX}/${TOTAL_STEPS} | Stable ${STABLE_WEIGHT}% / Canary ${CANARY_WEIGHT}% |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detailed canary info for vote
          if kubectl get rollout "vote-rollout" -n "${NAMESPACE}" &>/dev/null; then
            ROLLOUT_JSON=$(kubectl get rollout "vote-rollout" -n "${NAMESPACE}" -o json 2>/dev/null)
            STEP_INDEX=$(echo "$ROLLOUT_JSON" | jq -r '.status.currentStepIndex // 0')
            TOTAL_STEPS=$(echo "$ROLLOUT_JSON" | jq -r '.spec.strategy.canary.steps | length')
            
            echo "### Vote Canary Progress" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Step | Action | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            
            for i in $(seq 0 $((TOTAL_STEPS - 1))); do
              STEP=$(echo "$ROLLOUT_JSON" | jq -r ".spec.strategy.canary.steps[$i]")
              WEIGHT=$(echo "$STEP" | jq -r '.setWeight // empty')
              PAUSE=$(echo "$STEP" | jq -r '.pause.duration // empty')
              
              if [ "$i" -lt "$STEP_INDEX" ]; then
                MARKER="âœ… Done"
              elif [ "$i" -eq "$STEP_INDEX" ]; then
                MARKER="â–¶ï¸ **Current**"
              else
                MARKER="â¬œ Pending"
              fi
              
              STEP_NUM=$((i + 1))
              if [ -n "$WEIGHT" ] && [ "$WEIGHT" != "null" ]; then
                echo "| ${STEP_NUM} | Traffic ${WEIGHT}% | ${MARKER} |" >> $GITHUB_STEP_SUMMARY
              elif [ -n "$PAUSE" ] && [ "$PAUSE" != "null" ]; then
                echo "| ${STEP_NUM} | Pause ${PAUSE} | ${MARKER} |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ENVIRONMENT URLS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Environment URLs
        run: |
          echo "## ğŸ”— Environment URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Vote App | Results App |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **DEV** | [opsera-voting-app.agent.opsera.dev](https://opsera-voting-app.agent.opsera.dev) | [results.opsera-voting-app.agent.opsera.dev](https://results.opsera-voting-app.agent.opsera.dev) |" >> $GITHUB_STEP_SUMMARY
          echo "| **QA** ğŸ¤ | [opsera-voting-app-qa.agent.opsera.dev](https://opsera-voting-app-qa.agent.opsera.dev) | [results.opsera-voting-app-qa.agent.opsera.dev](https://results.opsera-voting-app-qa.agent.opsera.dev) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # QUICK ACTIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Quick Actions
        run: |
          echo "## ğŸ“‹ Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Workflow |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Images | [ğŸ”¨ CI: Build Images](../workflows/1-ci-build.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy to DEV | [ğŸš€ CD: Deploy to DEV](../workflows/3-cd-deploy-dev.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| Promote to QA | [â¬†ï¸ CD: Promote DEV â†’ QA](../workflows/4-cd-promote-qa.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| Debug Pods | [ğŸ”§ Ops: Debug Pods](../workflows/ops-debug-pods.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by Opsera Code-to-Cloud Platform*" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SLACK NOTIFICATION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Send to Slack
        if: ${{ github.event.inputs.slack_notify == 'true' || github.event_name == 'schedule' }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not configured"
            exit 0
          fi
          
          ENV_DATA=$(cat /tmp/env_data.json)
          
          # Build environment fields
          ENV_FIELDS=""
          for ENV in dev qa; do
            HEALTH=$(echo "$ENV_DATA" | jq -r ".environments[] | select(.name==\"$ENV\") | .health")
            BUILD=$(echo "$ENV_DATA" | jq -r ".environments[] | select(.name==\"$ENV\") | .build")
            
            case "$HEALTH" in
              "Healthy") EMOJI="ğŸŸ¢" ;;
              "Progressing") EMOJI="ğŸ”µ" ;;
              "Degraded") EMOJI="ğŸ”´" ;;
              *) EMOJI="âšª" ;;
            esac
            
            [ "$ENV" = "qa" ] && LABEL="QA ğŸ¤" || LABEL="DEV"
            ENV_FIELDS="${ENV_FIELDS}{\"type\":\"mrkdwn\",\"text\":\"*${LABEL}* ${EMOJI}\\n\`${BUILD:-N/A}\`\"},"
          done
          
          ENV_FIELDS="${ENV_FIELDS%,}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {"type": "header", "text": {"type": "plain_text", "text": "ğŸŒ Deployment Landscape", "emoji": true}},
                {"type": "section", "text": {"type": "mrkdwn", "text": "*Application:* `voting-app`\n*Pipeline:* DEV â†’ QA (Canary)"}},
                {"type": "divider"},
                {"type": "section", "fields": ['"${ENV_FIELDS}"']},
                {"type": "context", "elements": [{"type": "mrkdwn", "text": "ğŸ“Š <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Report>"}]}
              ]
            }' \
            "$SLACK_WEBHOOK" || true
