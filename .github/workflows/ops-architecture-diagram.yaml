# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ARCHITECTURE DIAGRAM GENERATOR                                               â•‘
# â•‘                                                                                â•‘
# â•‘  Generates deployment architecture diagrams:                                   â•‘
# â•‘  â€¢ Kubernetes resource topology                                                â•‘
# â•‘  â€¢ Service dependencies                                                        â•‘
# â•‘  â€¢ Network flow visualization                                                  â•‘
# â•‘  â€¢ CI/CD pipeline diagram                                                      â•‘
# â•‘                                                                                â•‘
# â•‘  Output formats: Mermaid, ASCII, DOT (Graphviz)                                â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ¨ Ops: Architecture Diagram"

on:
  workflow_dispatch:
    inputs:
      diagram_type:
        description: 'Diagram type'
        required: true
        type: choice
        options:
          - deployment-architecture
          - kubernetes-topology
          - ci-cd-pipeline
          - data-flow
          - all
        default: 'deployment-architecture'
      environment:
        description: 'Environment to visualize'
        required: true
        type: choice
        options:
          - dev
          - qa
          - all
        default: 'all'
      output_format:
        description: 'Output format'
        required: true
        type: choice
        options:
          - mermaid
          - ascii
          - summary
        default: 'mermaid'

env:
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  APP_NAME: voting-app

permissions:
  contents: read
  id-token: write

jobs:
  generate-diagrams:
    name: "ğŸ¨ Generate Architecture Diagrams"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOYMENT ARCHITECTURE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ—ï¸ Generate Deployment Architecture"
        if: inputs.diagram_type == 'deployment-architecture' || inputs.diagram_type == 'all'
        run: |
          echo "## ğŸ—ï¸ Deployment Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.output_format }}" = "mermaid" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'MERMAID'
          ```mermaid
          graph TB
              subgraph "Internet"
                  USER[("ğŸ‘¤ Users")]
              end
              
              subgraph "AWS Cloud"
                  subgraph "Route53"
                      DNS_DEV["ğŸŒ opsera-voting-app-dev.agent.opsera.dev"]
                      DNS_QA["ğŸŒ opsera-voting-app-qa.agent.opsera.dev"]
                  end
                  
                  subgraph "EKS Cluster: opsera-usw2-np"
                      subgraph "ingress-nginx namespace"
                          NGINX["ğŸ”· NGINX Ingress Controller<br/>+ cert-manager TLS"]
                      end
                      
                      subgraph "voting-app-dev namespace"
                          VOTE_DEV["ğŸ—³ï¸ Vote Service<br/>(Python Flask)"]
                          RESULT_DEV["ğŸ“Š Result Service<br/>(Node.js)"]
                          WORKER_DEV["âš™ï¸ Worker<br/>(.NET)"]
                          REDIS_DEV[("ğŸ”´ Redis<br/>Queue")]
                          DB_DEV[("ğŸ˜ PostgreSQL<br/>Database")]
                      end
                      
                      subgraph "voting-app-qa namespace"
                          VOTE_QA["ğŸ—³ï¸ Vote Service<br/>(Canary)"]
                          RESULT_QA["ğŸ“Š Result Service"]
                          WORKER_QA["âš™ï¸ Worker"]
                          REDIS_QA[("ğŸ”´ Redis")]
                          DB_QA[("ğŸ˜ PostgreSQL")]
                      end
                      
                      subgraph "argocd namespace"
                          ARGOCD["ğŸ”„ ArgoCD<br/>GitOps Controller"]
                      end
                      
                      subgraph "argo-rollouts namespace"
                          ROLLOUTS["ğŸ“ˆ Argo Rollouts<br/>Canary Controller"]
                      end
                  end
                  
                  subgraph "ECR"
                      ECR_VOTE["ğŸ“¦ vote:tag"]
                      ECR_RESULT["ğŸ“¦ result:tag"]
                      ECR_WORKER["ğŸ“¦ worker:tag"]
                  end
              end
              
              subgraph "GitHub"
                  REPO["ğŸ“‚ Repository"]
                  ACTIONS["âš¡ GitHub Actions<br/>CI/CD Pipeline"]
              end
              
              subgraph "Monitoring"
                  NR["ğŸ“Š New Relic<br/>APM & Metrics"]
                  SLACK["ğŸ’¬ Slack<br/>Notifications"]
              end
              
              USER --> DNS_DEV & DNS_QA
              DNS_DEV --> NGINX
              DNS_QA --> NGINX
              NGINX --> VOTE_DEV & RESULT_DEV
              NGINX --> VOTE_QA & RESULT_QA
              
              VOTE_DEV --> REDIS_DEV
              WORKER_DEV --> REDIS_DEV
              WORKER_DEV --> DB_DEV
              RESULT_DEV --> DB_DEV
              
              VOTE_QA --> REDIS_QA
              WORKER_QA --> REDIS_QA
              WORKER_QA --> DB_QA
              RESULT_QA --> DB_QA
              
              REPO --> ACTIONS
              ACTIONS --> ECR_VOTE & ECR_RESULT & ECR_WORKER
              ACTIONS --> ARGOCD
              ARGOCD --> VOTE_DEV & VOTE_QA
              ROLLOUTS --> VOTE_QA
              
              VOTE_DEV & VOTE_QA -.-> NR
              ACTIONS -.-> SLACK
          ```
          MERMAID
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # KUBERNETES TOPOLOGY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "â˜¸ï¸ Generate Kubernetes Topology"
        if: inputs.diagram_type == 'kubernetes-topology' || inputs.diagram_type == 'all'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â˜¸ï¸ Kubernetes Resource Topology" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          ENVS="${{ inputs.environment }}"
          [ "$ENVS" = "all" ] && ENVS="dev qa"
          
          for ENV in $ENVS; do
            NAMESPACE="voting-app-${ENV}"
            
            echo "### ${ENV^^} Environment (\`${NAMESPACE}\`)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ inputs.output_format }}" = "mermaid" ]; then
              cat >> $GITHUB_STEP_SUMMARY << MERMAID
          \`\`\`mermaid
          graph LR
              subgraph "${NAMESPACE}"
                  subgraph "Deployments/Rollouts"
          MERMAID
              
              # Get deployments and rollouts
              DEPS=$(kubectl get deployments,rollouts -n $NAMESPACE -o name 2>/dev/null | sed 's/.*\///')
              for DEP in $DEPS; do
                REPLICAS=$(kubectl get deployment,rollout $DEP -n $NAMESPACE -o jsonpath='{.status.replicas}' 2>/dev/null || echo "?")
                echo "            ${DEP}[\"${DEP}<br/>Replicas: ${REPLICAS}\"]" >> $GITHUB_STEP_SUMMARY
              done
              
              cat >> $GITHUB_STEP_SUMMARY << MERMAID
                  end
                  subgraph "Services"
          MERMAID
              
              # Get services
              SVCS=$(kubectl get svc -n $NAMESPACE -o name 2>/dev/null | sed 's/.*\///')
              for SVC in $SVCS; do
                TYPE=$(kubectl get svc $SVC -n $NAMESPACE -o jsonpath='{.spec.type}' 2>/dev/null || echo "ClusterIP")
                PORT=$(kubectl get svc $SVC -n $NAMESPACE -o jsonpath='{.spec.ports[0].port}' 2>/dev/null || echo "?")
                echo "            svc_${SVC}[\"${SVC}<br/>${TYPE}:${PORT}\"]" >> $GITHUB_STEP_SUMMARY
              done
              
              cat >> $GITHUB_STEP_SUMMARY << MERMAID
                  end
                  subgraph "Storage"
          MERMAID
              
              # Get StatefulSets
              STS=$(kubectl get statefulsets -n $NAMESPACE -o name 2>/dev/null | sed 's/.*\///')
              for ST in $STS; do
                REPLICAS=$(kubectl get statefulset $ST -n $NAMESPACE -o jsonpath='{.status.replicas}' 2>/dev/null || echo "?")
                echo "            sts_${ST}[(\"${ST}<br/>Replicas: ${REPLICAS}\")]" >> $GITHUB_STEP_SUMMARY
              done
              
              cat >> $GITHUB_STEP_SUMMARY << 'MERMAID'
                  end
              end
          ```
          MERMAID
            fi
            
            # ASCII table view
            if [ "${{ inputs.output_format }}" = "ascii" ] || [ "${{ inputs.output_format }}" = "summary" ]; then
              echo "| Resource Type | Name | Status | Replicas |" >> $GITHUB_STEP_SUMMARY
              echo "|---------------|------|--------|----------|" >> $GITHUB_STEP_SUMMARY
              
              # Deployments
              kubectl get deployments -n $NAMESPACE -o json 2>/dev/null | \
                jq -r '.items[] | "| Deployment | \(.metadata.name) | \(.status.conditions[-1].type) | \(.status.readyReplicas // 0)/\(.status.replicas // 0) |"' >> $GITHUB_STEP_SUMMARY || true
              
              # Rollouts
              kubectl get rollouts -n $NAMESPACE -o json 2>/dev/null | \
                jq -r '.items[] | "| Rollout | \(.metadata.name) | \(.status.phase // "Unknown") | \(.status.readyReplicas // 0)/\(.spec.replicas // 0) |"' >> $GITHUB_STEP_SUMMARY || true
              
              # StatefulSets
              kubectl get statefulsets -n $NAMESPACE -o json 2>/dev/null | \
                jq -r '.items[] | "| StatefulSet | \(.metadata.name) | Ready | \(.status.readyReplicas // 0)/\(.status.replicas // 0) |"' >> $GITHUB_STEP_SUMMARY || true
              
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CI/CD PIPELINE DIAGRAM
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ”„ Generate CI/CD Pipeline Diagram"
        if: inputs.diagram_type == 'ci-cd-pipeline' || inputs.diagram_type == 'all'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”„ CI/CD Pipeline Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.output_format }}" = "mermaid" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'MERMAID'
          ```mermaid
          flowchart LR
              subgraph "Stage 0: Bootstrap"
                  B0[("ğŸ—ï¸ 00-bootstrap<br/>infrastructure")]
              end
              
              subgraph "Stage 1: CI - Test & Scan"
                  direction TB
                  T1["ğŸ” SAST<br/>(Semgrep)"]
                  T2["ğŸ“¦ SCA<br/>(Trivy)"]
                  T3["ğŸ” Secrets<br/>(Gitleaks)"]
                  T4["ğŸ“ Lint"]
                  T5["ğŸ§ª Unit Tests"]
                  T6{"ğŸš¦ Quality<br/>Gate"}
              end
              
              subgraph "Stage 2: CI - Build"
                  direction TB
                  B1["ğŸ”¨ Build Vote"]
                  B2["ğŸ”¨ Build Result"]
                  B3["ğŸ”¨ Build Worker"]
                  B4["ğŸ” Container Scan<br/>(Anchore)"]
                  B5["ğŸ“¤ Push to ECR"]
              end
              
              subgraph "Stage 3: CD - DEV"
                  D1["ğŸ“‹ Pre-deploy Check"]
                  D2["ğŸ“ Update Manifests"]
                  D3["ğŸ”„ ArgoCD Sync"]
                  D4["âœ… Verify Deployment"]
                  D5["ğŸ§ª Smoke Tests"]
              end
              
              subgraph "Stage 4: CD - QA"
                  Q0{"â¸ï¸ Manual<br/>Approval"}
                  Q1["ğŸ“‹ Pre-deploy Check"]
                  Q2["ğŸ“ Update Manifests"]
                  Q3["ğŸ”„ ArgoCD Sync"]
              end
              
              subgraph "Stage 5: Canary"
                  C1["ğŸ“Š 10% Traffic"]
                  C2["ğŸ“Š 30% Traffic"]
                  C3["ğŸ“Š 60% Traffic"]
                  C4["ğŸ“Š 100% Traffic"]
                  C5{"ğŸ“ˆ New Relic<br/>Analysis"}
              end
              
              subgraph "Notifications"
                  N1["ğŸ’¬ Slack"]
                  N2["ğŸ« Jira"]
              end
              
              B0 --> T1 & T2 & T3 & T4 & T5
              T1 & T2 & T3 & T4 & T5 --> T6
              T6 -->|Pass| B1 & B2 & B3
              T6 -->|Fail| N1
              B1 & B2 & B3 --> B4
              B4 --> B5
              B5 --> D1
              D1 --> D2 --> D3 --> D4 --> D5
              D5 --> Q0
              Q0 -->|Approved| Q1
              Q0 -->|Rejected| N1
              Q1 --> Q2 --> Q3
              Q3 --> C1
              C1 --> C5
              C5 -->|Healthy| C2
              C5 -->|Unhealthy| N1
              C2 --> C3 --> C4
              C4 --> N1 & N2
          ```
          MERMAID
          fi
          
          if [ "${{ inputs.output_format }}" = "ascii" ] || [ "${{ inputs.output_format }}" = "summary" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'ASCII'
          
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                           CI/CD PIPELINE FLOW                                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          STAGE 0: BOOTSTRAP (One-time)
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ğŸ—ï¸  00-bootstrap          â”‚â”€â”€â†’ ECR, K8s Namespaces, ArgoCD Apps, GitHub Envs
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          STAGE 1: CI - TEST & SCAN (Parallel)
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ğŸ” SAST    â”‚ â”‚ ğŸ“¦ SCA     â”‚ â”‚ ğŸ” Secrets â”‚ â”‚ ğŸ“ Lint    â”‚ â”‚ ğŸ§ª Tests   â”‚
          â”‚ (Semgrep)  â”‚ â”‚ (Trivy)    â”‚ â”‚ (Gitleaks) â”‚ â”‚            â”‚ â”‚            â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚              â”‚              â”‚              â”‚              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚ ğŸš¦ Quality   â”‚
                                     â”‚    Gate      â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
          STAGE 2: CI - BUILD (Parallel)    â”‚
                                            â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ğŸ”¨ Build   â”‚ â”‚ ğŸ”¨ Build   â”‚ â”‚ ğŸ”¨ Build   â”‚
          â”‚   Vote     â”‚ â”‚   Result   â”‚ â”‚   Worker   â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚              â”‚              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ ğŸ” Container â”‚
                      â”‚    Scan      â”‚â”€â”€â†’ Push to ECR
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
          STAGE 3: CD - DEV  â”‚
                             â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Pre-check â†’ Update Manifests â†’ ArgoCD Sync â†’ Verify â†’ Smoke    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
          STAGE 4: CD - QA                    â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚ â¸ï¸  Manual    â”‚
                                     â”‚   Approval   â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Pre-check â†’ Update Manifests â†’ ArgoCD Sync                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
          STAGE 5: CANARY                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  10%   â”‚â”€â”€â”€â–¶â”‚  30%   â”‚â”€â”€â”€â–¶â”‚  60%   â”‚â”€â”€â”€â–¶â”‚ 100%   â”‚
          â”‚Traffic â”‚    â”‚Traffic â”‚    â”‚Traffic â”‚    â”‚Traffic â”‚
          â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚             â”‚             â”‚             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ ğŸ“Š New Relic      â”‚
                          â”‚    Analysis       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```
          ASCII
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DATA FLOW DIAGRAM
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ”€ Generate Data Flow Diagram"
        if: inputs.diagram_type == 'data-flow' || inputs.diagram_type == 'all'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”€ Application Data Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.output_format }}" = "mermaid" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'MERMAID'
          ```mermaid
          sequenceDiagram
              participant U as ğŸ‘¤ User
              participant V as ğŸ—³ï¸ Vote Service
              participant R as ğŸ”´ Redis
              participant W as âš™ï¸ Worker
              participant DB as ğŸ˜ PostgreSQL
              participant RS as ğŸ“Š Result Service
              participant NR as ğŸ“ˆ New Relic
              
              Note over U,NR: Voting Flow
              
              U->>V: Cast vote (Cats/Dogs)
              activate V
              V->>NR: Record transaction
              V->>R: LPUSH vote:{voter_id, vote}
              V-->>U: Vote confirmed
              deactivate V
              
              Note over R,DB: Background Processing
              
              loop Continuous
                  W->>R: RPOP vote
                  activate W
                  W->>DB: UPSERT votes SET vote = ?
                  W->>NR: Record transaction
                  deactivate W
              end
              
              Note over U,RS: Results Display
              
              U->>RS: View results
              activate RS
              RS->>DB: SELECT vote, COUNT(*) GROUP BY vote
              RS->>NR: Record transaction
              RS-->>U: Results (WebSocket updates)
              deactivate RS
              
              Note over V,NR: Canary Analysis
              
              NR-->>NR: Aggregate metrics:<br/>Error Rate, Latency, Apdex
              NR-->>W: Canary health check
          ```
          MERMAID
          fi
          
          if [ "${{ inputs.output_format }}" = "ascii" ] || [ "${{ inputs.output_format }}" = "summary" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'ASCII'
          
          ### Voting Flow
          
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  User  â”‚â”€â”€â”€â”€â–¶â”‚  Vote Service  â”‚â”€â”€â”€â”€â–¶â”‚   Redis   â”‚
          â”‚        â”‚     â”‚  (Flask/Py)    â”‚     â”‚  (Queue)  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚  Worker   â”‚
                                               â”‚  (.NET)   â”‚
                                               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚ PostgreSQL â”‚
                                              â”‚ (Database) â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  User  â”‚â—€â”€â”€â”€â”€â”‚  Result Service    â”‚
                         â”‚        â”‚     â”‚  (Node.js/Socket)  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```
          
          ### Data Stores
          
          | Store | Purpose | Data |
          |-------|---------|------|
          | Redis | Vote Queue | `{voter_id, vote}` |
          | PostgreSQL | Vote Storage | `votes(id, vote)` |
          
          ASCII
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ“‹ Diagram Summary"
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Diagram Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Diagram Type | ${{ inputs.diagram_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Output Format | ${{ inputs.output_format }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Generated | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tip:** Mermaid diagrams render automatically in GitHub Markdown and can be exported as images." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Vote URL | Result URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | [vote-dev](https://opsera-voting-app-dev.agent.opsera.dev) | [result-dev](https://results.opsera-voting-app-dev.agent.opsera.dev) |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | [vote-qa](https://opsera-voting-app-qa.agent.opsera.dev) | [result-qa](https://results.opsera-voting-app-qa.agent.opsera.dev) |" >> $GITHUB_STEP_SUMMARY
