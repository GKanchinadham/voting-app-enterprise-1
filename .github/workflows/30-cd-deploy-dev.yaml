# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                                ‚ïë
# ‚ïë              ENTERPRISE CD PIPELINE - DEPLOY TO DEV                            ‚ïë
# ‚ïë                                                                                ‚ïë
# ‚ïë  Stage 3 of the CI/CD Pipeline:                                                ‚ïë
# ‚ïë  ‚Ä¢ Jira ticket creation & tracking                                             ‚ïë
# ‚ïë  ‚Ä¢ Update Kustomize manifests                                                  ‚ïë
# ‚ïë  ‚Ä¢ Trigger ArgoCD sync                                                         ‚ïë
# ‚ïë  ‚Ä¢ Validate deployment health                                                  ‚ïë
# ‚ïë  ‚Ä¢ Run smoke tests                                                             ‚ïë
# ‚ïë  ‚Ä¢ Generate architecture diagram                                               ‚ïë
# ‚ïë  ‚Ä¢ Comprehensive deployment report                                             ‚ïë
# ‚ïë                                                                                ‚ïë
# ‚ïë  Powered by Opsera - The Unified DevOps Platform                               ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

name: "üöÄ CD: Deploy to DEV"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        type: string
  workflow_call:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        type: string

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  ENVIRONMENT: dev
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  DEV_URL: https://opsera-voting-app-dev.agent.opsera.dev
  DEV_RESULTS_URL: https://results.opsera-voting-app-dev.agent.opsera.dev
  # Jira Configuration
  JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL || 'https://opsera-jira-mock-labs.agent.opsera.dev' }}
  JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY || 'PR1' }}

permissions:
  contents: write
  id-token: write

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JIRA: CREATE DEPLOYMENT TICKET
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  jira-create-ticket:
    name: "üé´ Create Jira Ticket"
    runs-on: ubuntu-latest
    outputs:
      ticket_key: ${{ steps.create.outputs.ticket_key }}
      ticket_url: ${{ steps.create.outputs.ticket_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Create Deployment Ticket
        id: create
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          echo "## üé´ Jira Deployment Ticket" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$JIRA_TOKEN" ]; then
            echo "‚ö†Ô∏è Jira not configured - using mock ticket" >> $GITHUB_STEP_SUMMARY
            echo "ticket_key=MOCK-001" >> $GITHUB_OUTPUT
            echo "ticket_url=${{ env.JIRA_BASE_URL }}/ui" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null | head -1 | sed 's/"/\\"/g' || echo "Deployment")
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          WORKFLOW_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          DESCRIPTION="DEV Deployment: Image ${IMAGE_TAG} by ${GITHUB_ACTOR} at ${TIMESTAMP}"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue" \
            -d "{
              \"fields\": {
                \"project\": {\"key\": \"${{ env.JIRA_PROJECT_KEY }}\"},
                \"summary\": \"[Deploy] DEV: ${IMAGE_TAG} - ${{ env.APP_NAME }}\",
                \"description\": \"${DESCRIPTION}\",
                \"issuetype\": {\"name\": \"Task\"},
                \"priority\": {\"name\": \"High\"}
              }
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            TICKET_KEY=$(echo "$BODY" | jq -r '.key')
            TICKET_URL="${{ env.JIRA_BASE_URL }}/ui?issue=${TICKET_KEY}"
            
            echo "ticket_key=${TICKET_KEY}" >> $GITHUB_OUTPUT
            echo "ticket_url=${TICKET_URL}" >> $GITHUB_OUTPUT
            
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Ticket | [${TICKET_KEY}](${TICKET_URL}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Image Tag | \`${IMAGE_TAG}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Status | ‚úÖ Created |" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Failed to create Jira ticket (HTTP ${HTTP_CODE})" >> $GITHUB_STEP_SUMMARY
            echo "ticket_key=" >> $GITHUB_OUTPUT
            echo "ticket_url=" >> $GITHUB_OUTPUT
          fi

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # PRE-DEPLOYMENT VALIDATION
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  pre-deploy-check:
    name: "üîé Pre-Deploy Check"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket]
    outputs:
      ready: ${{ steps.check.outputs.ready }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify Image Exists
        id: check
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          echo "## üîé Pre-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          READY=true
          
          for SERVICE in vote result worker; do
            if aws ecr describe-images --repository-name "$SERVICE" --image-ids imageTag="${IMAGE_TAG}" &>/dev/null; then
              echo "| \`${SERVICE}:${IMAGE_TAG}\` | ‚úÖ Found |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| \`${SERVICE}:${IMAGE_TAG}\` | ‚ùå Not Found |" >> $GITHUB_STEP_SUMMARY
              READY=false
            fi
          done
          
          echo "ready=${READY}" >> $GITHUB_OUTPUT
          
          if [ "$READY" = "false" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå **Pre-deployment check failed** - one or more images not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Update Jira - Pre-check Complete
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          STATUS="${{ steps.check.outcome }}"
          [ "$STATUS" = "success" ] && MSG="‚úÖ Pre-deployment validation passed" || MSG="‚ùå Pre-deployment validation failed"
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"${MSG}\\n\\nAll container images verified in ECR.\"}" || true

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # UPDATE MANIFESTS
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  update-manifests:
    name: "üìù Update Manifests"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, pre-deploy-check]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Kustomization
        id: update
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          KUSTOMIZE_FILE=".opsera-${{ env.APP_NAME }}/k8s/overlays/${{ env.ENVIRONMENT }}/kustomization.yaml"
          
          # Update image references
          sed -i "s|newName: .*/vote|newName: ${ECR_URI}/vote|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/result|newName: ${ECR_URI}/result|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/worker|newName: ${ECR_URI}/worker|" "$KUSTOMIZE_FILE"
          sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|g" "$KUSTOMIZE_FILE"
          
          echo "### üìù Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "Updated \`${KUSTOMIZE_FILE}\` with tag \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add .
          git diff --staged --quiet || git commit -m "chore(dev): deploy ${{ inputs.image_tag }} [skip ci]"
          git push origin main || echo "No changes to push"

      - name: Update Jira - Manifests Updated
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"‚úÖ Kustomize manifests updated\\n\\nImage tag: ${{ inputs.image_tag }}\\nCommit pushed to main branch.\"}" || true

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # ARGOCD SYNC
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  argocd-sync:
    name: "üîÑ ArgoCD Sync"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, update-manifests]
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Sync ArgoCD Application
        id: sync
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          APP_NAME="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          
          # Hard refresh
          kubectl patch application "${APP_NAME}" -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
          
          sleep 5
          
          # Trigger sync
          kubectl patch application "${APP_NAME}" -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true}}}' || true
          
          echo "### üîÑ ArgoCD Sync" >> $GITHUB_STEP_SUMMARY
          echo "Triggered sync for \`${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY

      - name: Update Jira - ArgoCD Sync
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"üîÑ ArgoCD sync triggered\\n\\nApplication: ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}\\nCluster: ${{ env.HUB_CLUSTER }}\"}" || true

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # VERIFY DEPLOYMENT
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  verify-deployment:
    name: "‚úÖ Verify Deployment"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, argocd-sync]
    outputs:
      healthy: ${{ steps.verify.outputs.healthy }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Wait for Deployment
        id: verify
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          APP_NAME="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          MAX_ATTEMPTS=30
          
          echo "### ‚úÖ Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            SYNC=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            HEALTH=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
            
            echo "[$i/$MAX_ATTEMPTS] Sync: ${SYNC}, Health: ${HEALTH}"
            
            if [ "$SYNC" = "Synced" ] && [ "$HEALTH" = "Healthy" ]; then
              echo "| Sync Status | ‚úÖ ${SYNC} |" >> $GITHUB_STEP_SUMMARY
              echo "| Health Status | üü¢ ${HEALTH} |" >> $GITHUB_STEP_SUMMARY
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            sleep 10
          done
          
          echo "| Sync Status | ‚ö†Ô∏è ${SYNC} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Status | ‚ö†Ô∏è ${HEALTH} |" >> $GITHUB_STEP_SUMMARY
          echo "healthy=false" >> $GITHUB_OUTPUT

      - name: Update Jira - Deployment Verified
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          HEALTHY="${{ steps.verify.outputs.healthy }}"
          [ "$HEALTHY" = "true" ] && MSG="‚úÖ Deployment verified healthy" || MSG="‚ö†Ô∏è Deployment health check had issues"
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"${MSG}\\n\\nArgoCD application is synced and healthy.\"}" || true

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # SMOKE TESTS
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  smoke-tests:
    name: "üß™ Smoke Tests"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, verify-deployment]
    outputs:
      passed: ${{ steps.test.outputs.passed }}
    
    steps:
      - name: Run Smoke Tests
        id: test
        run: |
          echo "### üß™ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Status | Response |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          
          PASSED=true
          
          # Test Vote App
          VOTE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.DEV_URL }}" --connect-timeout 10 -k || echo "000")
          if [ "$VOTE_STATUS" = "200" ] || [ "$VOTE_STATUS" = "301" ] || [ "$VOTE_STATUS" = "302" ]; then
            echo "| Vote App | ‚úÖ | HTTP ${VOTE_STATUS} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Vote App | ‚ö†Ô∏è | HTTP ${VOTE_STATUS} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test Results App
          RESULT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.DEV_RESULTS_URL }}" --connect-timeout 10 -k || echo "000")
          if [ "$RESULT_STATUS" = "200" ] || [ "$RESULT_STATUS" = "301" ] || [ "$RESULT_STATUS" = "302" ]; then
            echo "| Results App | ‚úÖ | HTTP ${RESULT_STATUS} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Results App | ‚ö†Ô∏è | HTTP ${RESULT_STATUS} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**DEV URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Vote: ${{ env.DEV_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- Results: ${{ env.DEV_RESULTS_URL }}" >> $GITHUB_STEP_SUMMARY

      - name: Update Jira - Smoke Tests
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"üß™ Smoke tests completed\\n\\nEndpoints verified:\\n‚Ä¢ Vote: ${{ env.DEV_URL }}\\n‚Ä¢ Results: ${{ env.DEV_RESULTS_URL }}\"}" || true

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # ARCHITECTURE DIAGRAM
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  generate-architecture:
    name: "üèóÔ∏è Architecture Diagram"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, smoke-tests]
    if: always() && needs.smoke-tests.result != 'cancelled'
    
    steps:
      - name: Generate Architecture Diagram
        run: |
          echo "## üèóÔ∏è Deployment Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### System Architecture - DEV Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'ARCH'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#2c5aa0', 'lineColor': '#5c5c5c', 'secondaryColor': '#f5f5f5', 'tertiaryColor': '#ffffff', 'background': '#ffffff'}}}%%
flowchart TB
    subgraph INTERNET["‚òÅÔ∏è INTERNET"]
        USER["üë§ Users"]
    end

    subgraph AWS["‚òÅÔ∏è AWS CLOUD"]
        subgraph ROUTE53["üåê Route 53 DNS"]
            DNS["opsera-voting-app-dev.agent.opsera.dev"]
        end
        
        subgraph EKS["‚éà EKS Cluster: opsera-usw2-np"]
            subgraph INGRESS["üî∑ Ingress Layer"]
                NGINX["NGINX Ingress Controller\n+ cert-manager TLS"]
            end
            
            subgraph DEV_NS["üì¶ voting-app-dev namespace"]
                direction TB
                VOTE["üó≥Ô∏è Vote Service\nPython Flask\nReplicas: 2"]
                RESULT["üìä Result Service\nNode.js Express\nReplicas: 2"]
                WORKER["‚öôÔ∏è Worker\n.NET Core\nReplicas: 1"]
                REDIS[("üî¥ Redis\nIn-Memory Queue")]
                POSTGRES[("üêò PostgreSQL\nPersistent Storage")]
            end
            
            subgraph PLATFORM["üîß Platform Services"]
                ARGOCD["üîÑ ArgoCD\nGitOps Controller"]
                EXTDNS["üìç ExternalDNS\nDNS Automation"]
            end
        end
        
        subgraph ECR["üì¶ ECR Registry"]
            IMG_VOTE["vote:$TAG"]
            IMG_RESULT["result:$TAG"]
            IMG_WORKER["worker:$TAG"]
        end
    end

    subgraph GITHUB["üêô GitHub"]
        REPO["üìÇ Repository"]
        GHA["‚ö° GitHub Actions"]
    end

    subgraph MONITOR["üìä Monitoring"]
        NEWRELIC["üìà New Relic APM"]
        SLACK["üí¨ Slack"]
        JIRA["üé´ Jira"]
    end

    %% Flow with numbers
    USER -->|"1Ô∏è‚É£ HTTPS Request"| DNS
    DNS -->|"2Ô∏è‚É£ Route"| NGINX
    NGINX -->|"3Ô∏è‚É£ /vote"| VOTE
    NGINX -->|"3Ô∏è‚É£ /result"| RESULT
    
    VOTE -->|"4Ô∏è‚É£ Queue Vote"| REDIS
    WORKER -->|"5Ô∏è‚É£ Process"| REDIS
    WORKER -->|"6Ô∏è‚É£ Persist"| POSTGRES
    RESULT -->|"7Ô∏è‚É£ Query"| POSTGRES
    
    REPO -->|"8Ô∏è‚É£ Push"| GHA
    GHA -->|"9Ô∏è‚É£ Build & Push"| ECR
    GHA -->|"üîü Sync"| ARGOCD
    ARGOCD -->|"1Ô∏è‚É£1Ô∏è‚É£ Deploy"| DEV_NS
    
    DEV_NS -.->|"Metrics"| NEWRELIC
    GHA -.->|"Notify"| SLACK
    GHA -.->|"Track"| JIRA

    classDef aws fill:#ff9900,stroke:#232f3e,color:#232f3e
    classDef k8s fill:#326ce5,stroke:#fff,color:#fff
    classDef app fill:#4a90d9,stroke:#2c5aa0,color:#fff
    classDef data fill:#3d9970,stroke:#2d7050,color:#fff
    classDef external fill:#6c757d,stroke:#495057,color:#fff
    
    class AWS aws
    class EKS,INGRESS,DEV_NS,PLATFORM k8s
    class VOTE,RESULT,WORKER app
    class REDIS,POSTGRES data
    class USER,GITHUB,MONITOR external
```
ARCH

      - name: Generate Sequence Diagram
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Flow Sequence" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'SEQ'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#2c5aa0', 'lineColor': '#5c5c5c', 'background': '#ffffff', 'actorBkg': '#4a90d9', 'actorTextColor': '#ffffff'}}}%%
sequenceDiagram
    autonumber
    
    participant DEV as üë®‚Äçüíª Developer
    participant GH as üêô GitHub
    participant GHA as ‚ö° GitHub Actions
    participant JIRA as üé´ Jira
    participant ECR as üì¶ ECR
    participant ARGO as üîÑ ArgoCD
    participant K8S as ‚éà Kubernetes
    participant APP as üó≥Ô∏è Application
    participant NR as üìà New Relic
    participant SLACK as üí¨ Slack

    rect rgb(240, 248, 255)
        Note over DEV,GH: Stage 1: Code Commit
        DEV->>GH: git push (code changes)
        GH->>GHA: Trigger CI/CD Pipeline
    end

    rect rgb(255, 248, 240)
        Note over GHA,JIRA: Stage 2: Pipeline Start
        GHA->>JIRA: Create deployment ticket
        JIRA-->>GHA: Ticket: PR1-XXX
        GHA->>SLACK: üì¢ Deployment started
    end

    rect rgb(240, 255, 240)
        Note over GHA,ECR: Stage 3: Build & Scan
        GHA->>GHA: Run security scans (SAST, SCA, Secrets)
        GHA->>GHA: Build container images
        GHA->>ECR: Push images (vote, result, worker)
        GHA->>JIRA: üìù Images pushed to ECR
    end

    rect rgb(248, 240, 255)
        Note over GHA,K8S: Stage 4: GitOps Deploy
        GHA->>GH: Update Kustomize manifests
        GHA->>ARGO: Trigger sync
        ARGO->>GH: Pull latest manifests
        ARGO->>K8S: Apply resources
        GHA->>JIRA: üìù ArgoCD sync triggered
    end

    rect rgb(255, 255, 240)
        Note over K8S,APP: Stage 5: Deployment
        K8S->>K8S: Rolling update pods
        K8S->>ECR: Pull new images
        K8S->>APP: Start new containers
        APP->>NR: Register APM agent
    end

    rect rgb(240, 255, 248)
        Note over GHA,APP: Stage 6: Verification
        GHA->>ARGO: Check sync status
        ARGO-->>GHA: ‚úÖ Synced & Healthy
        GHA->>APP: Run smoke tests
        APP-->>GHA: ‚úÖ HTTP 200 OK
        GHA->>JIRA: üìù Deployment verified
    end

    rect rgb(248, 255, 240)
        Note over GHA,SLACK: Stage 7: Completion
        GHA->>JIRA: ‚úÖ Close ticket (Done)
        GHA->>SLACK: ‚úÖ DEV deployment complete
        SLACK-->>DEV: üîî Notification
    end
```
SEQ

      - name: Generate Data Flow Diagram  
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Application Data Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'DATA'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#1a1a1a', 'background': '#ffffff'}}}%%
flowchart LR
    subgraph CLIENT["üë§ Client Browser"]
        BROWSER["üåê Web Browser"]
    end
    
    subgraph VOTING["üó≥Ô∏è Voting Flow"]
        direction TB
        V1["1Ô∏è‚É£ User visits\nvote.domain.com"]
        V2["2Ô∏è‚É£ Selects\nCats or Dogs"]
        V3["3Ô∏è‚É£ Submit\nvote"]
    end
    
    subgraph BACKEND["‚öôÔ∏è Backend Processing"]
        direction TB
        VOTE_SVC["üêç Vote Service\n(Flask)"]
        REDIS_Q[("üî¥ Redis Queue\nLPUSH vote")]
        WORKER_SVC["üîß Worker\n(.NET)"]
        PG_DB[("üêò PostgreSQL\nUPSERT vote")]
    end
    
    subgraph RESULTS["üìä Results Display"]
        direction TB
        RESULT_SVC["üìà Result Service\n(Node.js)"]
        R1["4Ô∏è‚É£ Real-time\nWebSocket updates"]
        R2["5Ô∏è‚É£ Vote percentages\ndisplayed"]
    end
    
    BROWSER --> V1 --> V2 --> V3
    V3 --> VOTE_SVC
    VOTE_SVC -->|"Queue"| REDIS_Q
    REDIS_Q -->|"RPOP"| WORKER_SVC
    WORKER_SVC -->|"Store"| PG_DB
    PG_DB -->|"SELECT"| RESULT_SVC
    RESULT_SVC --> R1 --> R2
    R2 --> BROWSER
    
    style VOTE_SVC fill:#4a90d9,stroke:#2c5aa0,color:#fff
    style WORKER_SVC fill:#68217a,stroke:#4a1857,color:#fff
    style RESULT_SVC fill:#3c873a,stroke:#2d6a2d,color:#fff
    style REDIS_Q fill:#dc382d,stroke:#a52a20,color:#fff
    style PG_DB fill:#336791,stroke:#264d6d,color:#fff
```
DATA

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # DEPLOYMENT SUMMARY
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  deployment-summary:
    name: "üìä Deployment Summary"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, pre-deploy-check, update-manifests, argocd-sync, verify-deployment, smoke-tests, generate-architecture]
    if: always()
    
    steps:
      - name: Generate Summary
        env:
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
          TICKET_URL: ${{ needs.jira-create-ticket.outputs.ticket_url }}
        run: |
          echo "## üöÄ DEV Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Jira ticket info
          if [ -n "$TICKET_KEY" ]; then
            echo "### üé´ Jira Tracking" >> $GITHUB_STEP_SUMMARY
            echo "**Ticket:** [${TICKET_KEY}](${TICKET_URL})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          [ "${{ needs.jira-create-ticket.result }}" = "success" ] && echo "| üé´ Jira Ticket | ‚úÖ |" >> $GITHUB_STEP_SUMMARY || echo "| üé´ Jira Ticket | ‚ö†Ô∏è |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.pre-deploy-check.result }}" = "success" ] && echo "| üîé Pre-Deploy Check | ‚úÖ |" >> $GITHUB_STEP_SUMMARY || echo "| üîé Pre-Deploy Check | ‚ùå |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.update-manifests.result }}" = "success" ] && echo "| üìù Update Manifests | ‚úÖ |" >> $GITHUB_STEP_SUMMARY || echo "| üìù Update Manifests | ‚ùå |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.argocd-sync.result }}" = "success" ] && echo "| üîÑ ArgoCD Sync | ‚úÖ |" >> $GITHUB_STEP_SUMMARY || echo "| üîÑ ArgoCD Sync | ‚ùå |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.verify-deployment.result }}" = "success" ] && echo "| ‚úÖ Verify Deployment | ‚úÖ |" >> $GITHUB_STEP_SUMMARY || echo "| ‚úÖ Verify Deployment | ‚ö†Ô∏è |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.smoke-tests.result }}" = "success" ] && echo "| üß™ Smoke Tests | ‚úÖ |" >> $GITHUB_STEP_SUMMARY || echo "| üß™ Smoke Tests | ‚ö†Ô∏è |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.generate-architecture.result }}" = "success" ] && echo "| üèóÔ∏è Architecture Diagram | ‚úÖ |" >> $GITHUB_STEP_SUMMARY || echo "| üèóÔ∏è Architecture Diagram | ‚ö†Ô∏è |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ inputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | DEV |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cluster** | ${{ env.SPOKE_CLUSTER }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed At** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Vote App | [${{ env.DEV_URL }}](${{ env.DEV_URL }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Results App | [${{ env.DEV_RESULTS_URL }}](${{ env.DEV_RESULTS_URL }}) |" >> $GITHUB_STEP_SUMMARY

      - name: Update Jira - Deployment Complete
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          OVERALL="${{ needs.smoke-tests.result }}"
          [ "$OVERALL" = "success" ] && STATUS="‚úÖ SUCCESSFUL" || STATUS="‚ö†Ô∏è COMPLETED WITH WARNINGS"
          
          COMMENT="üöÄ DEV DEPLOYMENT ${STATUS}

---------------------------------------
üìã Final Status:
‚Ä¢ Image Tag: ${{ inputs.image_tag }}
‚Ä¢ Environment: DEV  
‚Ä¢ Cluster: ${{ env.SPOKE_CLUSTER }}

üîó Application URLs:
‚Ä¢ Vote: ${{ env.DEV_URL }}
‚Ä¢ Results: ${{ env.DEV_RESULTS_URL }}

üìä Pipeline Results:
‚Ä¢ Pre-check: ${{ needs.pre-deploy-check.result }}
‚Ä¢ Manifests: ${{ needs.update-manifests.result }}
‚Ä¢ ArgoCD: ${{ needs.argocd-sync.result }}
‚Ä¢ Verification: ${{ needs.verify-deployment.result }}
‚Ä¢ Smoke Tests: ${{ needs.smoke-tests.result }}

üèóÔ∏è Architecture diagram generated in GitHub Actions summary."
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"${COMMENT}\"}" || true

      - name: Notify Slack - DEV Complete
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
          TICKET_URL: ${{ needs.jira-create-ticket.outputs.ticket_url }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then exit 0; fi
          
          STATUS="${{ needs.smoke-tests.result }}"
          [ "$STATUS" = "success" ] && EMOJI="‚úÖ" && COLOR="good" || EMOJI="‚ö†Ô∏è" && COLOR="warning"
          
          JIRA_BLOCK=""
          if [ -n "$TICKET_KEY" ]; then
            JIRA_BLOCK=',{"type": "section", "text": {"type": "mrkdwn", "text": "üé´ *Jira:* <'"${TICKET_URL}"'|'"${TICKET_KEY}"'>"}}'
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "attachments": [{
                "color": "'"${COLOR}"'",
                "blocks": [
                  {"type": "header", "text": {"type": "plain_text", "text": "'"${EMOJI}"' DEV Deployment Complete", "emoji": true}},
                  {"type": "section", "fields": [
                    {"type": "mrkdwn", "text": "*Image Tag:*\n`'"${{ inputs.image_tag }}"'`"},
                    {"type": "mrkdwn", "text": "*Environment:*\nDEV"}
                  ]}'"${JIRA_BLOCK}"',
                  {"type": "section", "text": {"type": "mrkdwn", "text": "*URLs:*\n‚Ä¢ <'"${{ env.DEV_URL }}"'|Vote App>\n‚Ä¢ <'"${{ env.DEV_RESULTS_URL }}"'|Results App>"}},
                  {"type": "context", "elements": [{"type": "mrkdwn", "text": "üìä Architecture diagram available in <'"${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"'|workflow summary>"}]},
                  {"type": "actions", "elements": [
                    {"type": "button", "text": {"type": "plain_text", "text": "‚¨ÜÔ∏è Promote to QA"}, "style": "primary", "url": "${{ github.server_url }}/${{ github.repository }}/actions/workflows/40-cd-promote-qa.yaml"}
                  ]}
                ]
              }]
            }' \
            "$SLACK_WEBHOOK" || true
