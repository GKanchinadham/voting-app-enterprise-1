name: "Debug - Ingress & App Connectivity"

on:
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  NAMESPACE: voting-app-dev

permissions:
  contents: read
  id-token: write

jobs:
  debug:
    name: "Debug Ingress"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Check Ingress Details
        run: |
          echo "## Ingress Configuration" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress voting-app -n ${{ env.NAMESPACE }} -o yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check TLS Certificate
        run: |
          echo "## TLS Certificate Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get certificate -n ${{ env.NAMESPACE }} 2>/dev/null || echo "No certificates found"
          echo "" >> $GITHUB_STEP_SUMMARY
          kubectl get secret voting-app-dev-tls -n ${{ env.NAMESPACE }} 2>/dev/null || echo "TLS secret not found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Service Endpoints
        run: |
          echo "## Service Endpoints" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Vote Service Endpoints:"
          kubectl get endpoints vote -n ${{ env.NAMESPACE }}
          echo ""
          echo "Result Service Endpoints:"
          kubectl get endpoints result -n ${{ env.NAMESPACE }}
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Test Internal Connectivity
        run: |
          echo "## Internal Connectivity Test" >> $GITHUB_STEP_SUMMARY

          # Run a test pod to curl the service
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n ${{ env.NAMESPACE }} -- \
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://vote:80/ 2>&1 || true

          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Testing vote service internally..."
          kubectl run curl-test2 --image=curlimages/curl --rm -i --restart=Never -n ${{ env.NAMESPACE }} -- \
            curl -s -w "\nHTTP Status: %{http_code}\n" http://vote:80/ 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || echo "Curl test failed"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Nginx Ingress Controller Logs
        run: |
          echo "## Nginx Ingress Controller" >> $GITHUB_STEP_SUMMARY

          # Find nginx ingress controller
          INGRESS_NS=$(kubectl get pods -A | grep ingress-nginx | head -1 | awk '{print $1}')
          INGRESS_POD=$(kubectl get pods -n $INGRESS_NS -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)

          if [ -n "$INGRESS_POD" ]; then
            echo "### Controller Pod: $INGRESS_POD" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs $INGRESS_POD -n $INGRESS_NS --tail=30 2>/dev/null | grep -i "voting\|error\|warn" | head -20 >> $GITHUB_STEP_SUMMARY || echo "No relevant logs"
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "Nginx ingress controller not found in expected location" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Pod Logs
        run: |
          echo "## Vote Pod Logs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -l app=vote -n ${{ env.NAMESPACE }} --tail=30 2>&1 | head -40 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: External URL Test
        run: |
          echo "## External URL Test" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Test HTTP
          echo "HTTP Test:"
          curl -s -o /dev/null -w "HTTP Status: %{http_code}, Redirect: %{redirect_url}\n" \
            http://opsera-voting-app-dev.agent.opsera.dev/ 2>&1 || echo "HTTP request failed"

          # Test HTTPS (with insecure flag in case cert isn't ready)
          echo ""
          echo "HTTPS Test:"
          curl -s -k -o /dev/null -w "HTTPS Status: %{http_code}\n" \
            https://opsera-voting-app-dev.agent.opsera.dev/ 2>&1 || echo "HTTPS request failed"

          # Get response body
          echo ""
          echo "Response Preview:"
          curl -s -k https://opsera-voting-app-dev.agent.opsera.dev/ 2>&1 | head -20 || echo "Could not get response"

          echo '```' >> $GITHUB_STEP_SUMMARY
