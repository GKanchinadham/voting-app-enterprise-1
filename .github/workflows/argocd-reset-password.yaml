name: "ArgoCD - Reset Admin Password"

on:
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2

permissions:
  contents: read
  id-token: write

jobs:
  reset-password:
    name: "Reset ArgoCD Admin Password"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Generate New Password
        id: password
        run: |
          # Generate a random password
          NEW_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 16)
          echo "::add-mask::$NEW_PASSWORD"
          echo "password=$NEW_PASSWORD" >> $GITHUB_OUTPUT

      - name: Reset ArgoCD Admin Password
        env:
          NEW_PASSWORD: ${{ steps.password.outputs.password }}
        run: |
          # Hash the password using bcrypt
          HASHED_PASSWORD=$(htpasswd -nbBC 10 "" "$NEW_PASSWORD" | tr -d ':\n' | sed 's/$2y/$2a/')

          # Patch the argocd-secret with new password
          kubectl -n argocd patch secret argocd-secret \
            -p "{\"stringData\": {\"admin.password\": \"$HASHED_PASSWORD\", \"admin.passwordMtime\": \"$(date +%FT%T%Z)\"}}"

          echo "Password reset successfully!"

      - name: Get ArgoCD URL
        run: |
          echo "## ArgoCD Access Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Try LoadBalancer first
          ARGOCD_URL=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")

          if [ -n "$ARGOCD_URL" ]; then
            echo "### ArgoCD URL" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "https://${ARGOCD_URL}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            # Check for ingress
            ARGOCD_INGRESS=$(kubectl get ingress -n argocd -o jsonpath='{.items[0].spec.rules[0].host}' 2>/dev/null || echo "")
            if [ -n "$ARGOCD_INGRESS" ]; then
              echo "### ArgoCD URL" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "https://${ARGOCD_INGRESS}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "### ArgoCD Service" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              kubectl get svc argocd-server -n argocd >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Note: No LoadBalancer or Ingress found. Use port-forward to access." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Display Credentials
        env:
          NEW_PASSWORD: ${{ steps.password.outputs.password }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Login Credentials" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Username:** \`admin\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Password:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${NEW_PASSWORD}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Save this password now** - it won't be shown again!" >> $GITHUB_STEP_SUMMARY

      - name: Show Application Status
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Application Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get applications -n argocd 2>/dev/null || echo "No applications found"
          echo '```' >> $GITHUB_STEP_SUMMARY
