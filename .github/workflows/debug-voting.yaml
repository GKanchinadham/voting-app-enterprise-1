name: "Debug - Voting Flow"

on:
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  NAMESPACE: voting-app-dev

permissions:
  contents: read
  id-token: write

jobs:
  debug:
    name: "Debug Voting"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Check Worker Logs
        run: |
          echo "## Worker Logs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -l app=worker -n ${{ env.NAMESPACE }} --tail=50 2>&1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Redis Queue
        run: |
          echo "## Redis Queue" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl exec -n ${{ env.NAMESPACE }} deploy/redis -- redis-cli LLEN votes 2>&1 >> $GITHUB_STEP_SUMMARY
          echo "Pending votes in queue: $(kubectl exec -n ${{ env.NAMESPACE }} deploy/redis -- redis-cli LLEN votes 2>/dev/null)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check PostgreSQL Votes
        run: |
          echo "## PostgreSQL Votes Table" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl exec -n ${{ env.NAMESPACE }} deploy/db -- psql -U postgres -c "SELECT vote, COUNT(*) FROM votes GROUP BY vote;" 2>&1 >> $GITHUB_STEP_SUMMARY || echo "Could not query votes"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check DB Connection from Worker
        run: |
          echo "## Worker DB Connection" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -l app=worker -n ${{ env.NAMESPACE }} --tail=100 2>&1 | grep -i "connect\|error\|exception\|database\|postgres" | head -20 >> $GITHUB_STEP_SUMMARY || echo "No connection logs found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check All Pod Status
        run: |
          echo "## Pod Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
