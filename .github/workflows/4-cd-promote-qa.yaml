# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                   ENTERPRISE CI/CD PIPELINE - PROMOTE TO QA                   â•‘
# â•‘                                                                                â•‘
# â•‘  This workflow handles promotion from DEV to QA with approval gate:           â•‘
# â•‘  â€¢ Manual approval via GitHub environment                                      â•‘
# â•‘  â€¢ Slack notification for approval request                                     â•‘
# â•‘  â€¢ Triggers QA canary deployment                                               â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "â¬†ï¸ CD: Promote DEV â†’ QA"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to promote (leave empty to auto-detect from DEV)'
        required: false
        type: string
      skip_approval:
        description: 'Skip approval (emergency only)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app

permissions:
  contents: write
  id-token: write

jobs:
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ DETECT: Get current DEV version                                              â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  detect-version:
    name: "ğŸ” Detect DEV Version"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      commit_url: ${{ steps.detect.outputs.commit_url }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Detect Current DEV Version
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          else
            # Extract from DEV kustomization
            IMAGE_TAG=$(grep -A2 "name: vote$" .opsera-voting-app/k8s/overlays/dev/kustomization.yaml | grep "newTag" | awk -F': ' '{print $2}' | tr -d ' "')
          fi
          
          COMMIT_HASH=$(echo "$IMAGE_TAG" | cut -d'-' -f1)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${COMMIT_HASH}"
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "commit_url=${COMMIT_URL}" >> $GITHUB_OUTPUT
          
          echo "### ğŸ” Version Detection" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${IMAGE_TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [${COMMIT_HASH}](${COMMIT_URL}) |" >> $GITHUB_STEP_SUMMARY

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ PRE-CHECK: Verify DEV is healthy                                             â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  pre-check:
    name: "ğŸ” Pre-flight Check"
    runs-on: ubuntu-latest
    needs: [detect-version]
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Check DEV Health
        run: |
          aws eks update-kubeconfig --name argocd-usw2 --region ${{ env.AWS_REGION }}
          
          HEALTH=$(kubectl get application "${{ env.APP_NAME }}-dev" -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
          SYNC=$(kubectl get application "${{ env.APP_NAME }}-dev" -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
          
          echo "### ğŸ” Pre-flight Check" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Health | Sync |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          [ "$HEALTH" = "Healthy" ] && H_EMOJI="ğŸŸ¢" || H_EMOJI="ğŸ”´"
          [ "$SYNC" = "Synced" ] && S_EMOJI="âœ…" || S_EMOJI="âš ï¸"
          
          echo "| DEV | ${H_EMOJI} ${HEALTH} | ${S_EMOJI} ${SYNC} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HEALTH" != "Healthy" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Warning:** DEV is not healthy. Promotion may fail." >> $GITHUB_STEP_SUMMARY
          fi

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ REQUEST APPROVAL: Send Slack notification                                    â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  request-approval:
    name: "ğŸ“¨ Request Approval"
    runs-on: ubuntu-latest
    needs: [detect-version, pre-check]
    if: ${{ github.event.inputs.skip_approval != 'true' }}
    
    steps:
      - name: Send Approval Request to Slack
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not configured - skipping notification"
            exit 0
          fi
          
          IMAGE_TAG="${{ needs.detect-version.outputs.image_tag }}"
          COMMIT_URL="${{ needs.detect-version.outputs.commit_url }}"
          COMMIT_HASH=$(echo "$IMAGE_TAG" | cut -d'-' -f1)
          APPROVE_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš¦ QA Promotion Approval Required",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Image Tag:*\n`'"${IMAGE_TAG}"'`"},
                    {"type": "mrkdwn", "text": "*Commit:*\n<'"${COMMIT_URL}"'|'"${COMMIT_HASH}"'>"}
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Flow:* DEV âœ… â†’ *QA* (Canary)"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "âœ… Approve & Deploy"},
                      "style": "primary",
                      "url": "'"${APPROVE_URL}"'"
                    },
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "ğŸ‘€ View Changes"},
                      "url": "'"${COMMIT_URL}"'"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {"type": "mrkdwn", "text": "Triggered by *${{ github.actor }}* | <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"}
                  ]
                }
              ]
            }' \
            "$SLACK_WEBHOOK"
          
          echo "### ğŸ“¨ Approval Request Sent" >> $GITHUB_STEP_SUMMARY
          echo "A Slack notification has been sent requesting approval." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** Approve the deployment to continue." >> $GITHUB_STEP_SUMMARY

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ APPROVAL GATE: GitHub Environment approval                                   â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  approval-gate:
    name: "ğŸš¦ Approval Gate"
    runs-on: ubuntu-latest
    needs: [detect-version, pre-check, request-approval]
    if: ${{ github.event.inputs.skip_approval != 'true' }}
    environment:
      name: qa-approval
      url: https://opsera-voting-app-qa.agent.opsera.dev
    
    steps:
      - name: Approval Confirmed
        run: |
          echo "### ğŸš¦ Approval Confirmed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment to QA has been approved!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ DEPLOY TO QA: Trigger QA deployment                                          â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  deploy-qa:
    name: "ğŸš€ Deploy to QA"
    runs-on: ubuntu-latest
    needs: [detect-version, approval-gate]
    if: always() && (needs.approval-gate.result == 'success' || github.event.inputs.skip_approval == 'true')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Update QA Manifests
        env:
          IMAGE_TAG: ${{ needs.detect-version.outputs.image_tag }}
        run: |
          KUSTOMIZE_FILE=".opsera-voting-app/k8s/overlays/qa/kustomization.yaml"
          
          # Get ECR URI
          AWS_ACCOUNT_ID="792373136340"
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          
          # Update image references
          sed -i "s|newName: .*/vote|newName: ${ECR_URI}/vote|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/result|newName: ${ECR_URI}/result|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/worker|newName: ${ECR_URI}/worker|" "$KUSTOMIZE_FILE"
          sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|g" "$KUSTOMIZE_FILE"
          
          echo "### ğŸ“ QA Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "Updated with tag: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add .
          git commit -m "chore(qa): promote ${IMAGE_TAG} from DEV [skip ci]" || echo "No changes"
          git push origin main || echo "Push failed"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync ArgoCD
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          
          aws eks update-kubeconfig --name argocd-usw2 --region ${{ env.AWS_REGION }}
          
          ./kubectl patch application "${{ env.APP_NAME }}-qa" -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
          
          sleep 5
          
          ./kubectl patch application "${{ env.APP_NAME }}-qa" -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true}}}' || true

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ NOTIFY: Send deployment notification                                         â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  notify-complete:
    name: "ğŸ“¢ Notify Complete"
    runs-on: ubuntu-latest
    needs: [detect-version, deploy-qa]
    if: always()
    
    steps:
      - name: Send Completion Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            exit 0
          fi
          
          STATUS="${{ needs.deploy-qa.result }}"
          [ "$STATUS" = "success" ] && EMOJI="âœ…" && COLOR="good" || EMOJI="âŒ" && COLOR="danger"
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "attachments": [{
                "color": "'"${COLOR}"'",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "'"${EMOJI}"' *QA Promotion Complete*\n\n*Image Tag:* `'"${{ needs.detect-version.outputs.image_tag }}"'`\n*Status:* '"${STATUS}"'\n*Canary:* ğŸ¤ Progressive rollout started"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {"type": "plain_text", "text": "ğŸ” View QA"},
                        "url": "https://opsera-voting-app-qa.agent.opsera.dev"
                      },
                      {
                        "type": "button",
                        "text": {"type": "plain_text", "text": "ğŸ“Š View Canary"},
                        "url": "https://github.com/${{ github.repository }}/actions/workflows/ops-deployment-landscape.yaml"
                      }
                    ]
                  }
                ]
              }]
            }' \
            "$SLACK_WEBHOOK" || true
