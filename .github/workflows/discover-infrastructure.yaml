name: "Discover Infrastructure URLs"

# ============================================================================
# This workflow discovers and validates infrastructure components:
# - Prometheus server URL (for canary analysis)
# - ArgoCD server URL (for GitOps)
# - Argo Rollouts controller (for canary deployments)
# - NGINX Ingress controller (for traffic splitting)
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'qa'
      update_analysis_template:
        description: 'Update analysis template with discovered Prometheus URL'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write
  id-token: write

jobs:
  discover:
    name: "Discover Infrastructure"
    runs-on: ubuntu-latest
    outputs:
      prometheus_url: ${{ steps.prometheus.outputs.url }}
      argocd_url: ${{ steps.argocd.outputs.url }}
      rollouts_installed: ${{ steps.rollouts.outputs.installed }}
      nginx_installed: ${{ steps.nginx.outputs.installed }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      # ============================================
      # Discover Prometheus
      # ============================================
      - name: Discover Prometheus Server
        id: prometheus
        run: |
          echo "## ðŸ” Prometheus Discovery" >> $GITHUB_STEP_SUMMARY
          
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          PROMETHEUS_URL=""
          PROMETHEUS_FOUND="false"
          
          # Common Prometheus service patterns to search
          SEARCH_PATTERNS=(
            "prometheus-server:monitoring"
            "prometheus-operated:monitoring"
            "prometheus:monitoring"
            "prometheus-server:prometheus"
            "prometheus:prometheus"
            "prometheus-server:default"
            "prometheus-kube-prometheus-prometheus:monitoring"
            "kube-prometheus-stack-prometheus:monitoring"
          )
          
          echo "### Searching for Prometheus..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Search in common namespaces
          for pattern in "${SEARCH_PATTERNS[@]}"; do
            SVC_NAME=$(echo $pattern | cut -d: -f1)
            NAMESPACE=$(echo $pattern | cut -d: -f2)
            
            # Check if service exists
            if kubectl get svc "$SVC_NAME" -n "$NAMESPACE" &>/dev/null; then
              # Get the service port
              PORT=$(kubectl get svc "$SVC_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}')
              PROMETHEUS_URL="http://${SVC_NAME}.${NAMESPACE}.svc.cluster.local:${PORT}"
              PROMETHEUS_FOUND="true"
              
              echo "âœ… **Found Prometheus!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Service | \`${SVC_NAME}\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Namespace | \`${NAMESPACE}\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Port | \`${PORT}\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Full URL | \`${PROMETHEUS_URL}\` |" >> $GITHUB_STEP_SUMMARY
              
              break
            fi
          done
          
          # If not found with patterns, search all namespaces
          if [ "$PROMETHEUS_FOUND" = "false" ]; then
            echo "### Searching all namespaces..." >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get svc -A 2>/dev/null | grep -i prom >> $GITHUB_STEP_SUMMARY || echo "No Prometheus services found"
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Try to find any prometheus service
            PROM_SVC=$(kubectl get svc -A 2>/dev/null | grep -i "prometheus" | head -1)
            if [ -n "$PROM_SVC" ]; then
              NAMESPACE=$(echo $PROM_SVC | awk '{print $1}')
              SVC_NAME=$(echo $PROM_SVC | awk '{print $2}')
              PORT=$(kubectl get svc "$SVC_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}')
              PROMETHEUS_URL="http://${SVC_NAME}.${NAMESPACE}.svc.cluster.local:${PORT}"
              PROMETHEUS_FOUND="true"
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Found Prometheus in namespace: ${NAMESPACE}**" >> $GITHUB_STEP_SUMMARY
              echo "- URL: \`${PROMETHEUS_URL}\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ "$PROMETHEUS_FOUND" = "false" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Prometheus NOT found in cluster**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ To install Prometheus:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "helm repo add prometheus-community https://prometheus-community.github.io/helm-charts" >> $GITHUB_STEP_SUMMARY
            echo "helm repo update" >> $GITHUB_STEP_SUMMARY
            echo "helm install prometheus prometheus-community/prometheus \\" >> $GITHUB_STEP_SUMMARY
            echo "  --namespace monitoring --create-namespace" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            PROMETHEUS_URL="NOT_FOUND"
          fi
          
          echo "url=${PROMETHEUS_URL}" >> $GITHUB_OUTPUT
          echo "found=${PROMETHEUS_FOUND}" >> $GITHUB_OUTPUT

      # ============================================
      # Discover ArgoCD
      # ============================================
      - name: Discover ArgoCD Server
        id: argocd
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” ArgoCD Discovery" >> $GITHUB_STEP_SUMMARY
          
          # Connect to hub cluster for ArgoCD
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          ARGOCD_URL=""
          ARGOCD_FOUND="false"
          
          # Check ArgoCD server service
          if kubectl get svc argocd-server -n argocd &>/dev/null; then
            ARGOCD_FOUND="true"
            
            # Get ArgoCD server details
            ARGOCD_SVC_TYPE=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.spec.type}')
            
            echo "âœ… **ArgoCD Server Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$ARGOCD_SVC_TYPE" = "LoadBalancer" ]; then
              ARGOCD_LB=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
              if [ -n "$ARGOCD_LB" ]; then
                ARGOCD_URL="https://${ARGOCD_LB}"
              fi
            fi
            
            # Check for ingress
            ARGOCD_INGRESS=$(kubectl get ingress -n argocd -o jsonpath='{.items[0].spec.rules[0].host}' 2>/dev/null)
            if [ -n "$ARGOCD_INGRESS" ]; then
              ARGOCD_URL="https://${ARGOCD_INGRESS}"
            fi
            
            # Internal URL
            ARGOCD_INTERNAL="https://argocd-server.argocd.svc.cluster.local"
            
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Service Type | \`${ARGOCD_SVC_TYPE}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Internal URL | \`${ARGOCD_INTERNAL}\` |" >> $GITHUB_STEP_SUMMARY
            if [ -n "$ARGOCD_URL" ]; then
              echo "| External URL | \`${ARGOCD_URL}\` |" >> $GITHUB_STEP_SUMMARY
            fi
            
            # List applications
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ArgoCD Applications" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get applications -n argocd --no-headers 2>/dev/null | awk '{print $1, $2, $3}' >> $GITHUB_STEP_SUMMARY || echo "No applications found"
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ArgoCD NOT found in argocd namespace**" >> $GITHUB_STEP_SUMMARY
            ARGOCD_URL="NOT_FOUND"
          fi
          
          echo "url=${ARGOCD_URL}" >> $GITHUB_OUTPUT
          echo "found=${ARGOCD_FOUND}" >> $GITHUB_OUTPUT

      # ============================================
      # Discover Argo Rollouts
      # ============================================
      - name: Discover Argo Rollouts Controller
        id: rollouts
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Argo Rollouts Discovery" >> $GITHUB_STEP_SUMMARY
          
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          ROLLOUTS_INSTALLED="false"
          
          # Check for Argo Rollouts controller
          if kubectl get deployment argo-rollouts -n argo-rollouts &>/dev/null; then
            ROLLOUTS_INSTALLED="true"
            
            # Get controller status
            READY=$(kubectl get deployment argo-rollouts -n argo-rollouts -o jsonpath='{.status.readyReplicas}')
            DESIRED=$(kubectl get deployment argo-rollouts -n argo-rollouts -o jsonpath='{.spec.replicas}')
            VERSION=$(kubectl get deployment argo-rollouts -n argo-rollouts -o jsonpath='{.spec.template.spec.containers[0].image}' | cut -d: -f2)
            
            echo "âœ… **Argo Rollouts Controller Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Status | \`${READY}/${DESIRED} Ready\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Version | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Namespace | \`argo-rollouts\` |" >> $GITHUB_STEP_SUMMARY
            
            # Check for Rollout resources in target namespace
            NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Rollouts in ${NAMESPACE}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get rollouts -n "${NAMESPACE}" 2>/dev/null || echo "No rollouts found or namespace doesn't exist"
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Check AnalysisTemplates
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Analysis Templates in ${NAMESPACE}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get analysistemplates -n "${NAMESPACE}" 2>/dev/null || echo "No analysis templates found"
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Argo Rollouts NOT installed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ To install Argo Rollouts:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "kubectl create namespace argo-rollouts" >> $GITHUB_STEP_SUMMARY
            echo "kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "installed=${ROLLOUTS_INSTALLED}" >> $GITHUB_OUTPUT

      # ============================================
      # Discover NGINX Ingress Controller
      # ============================================
      - name: Discover NGINX Ingress Controller
        id: nginx
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” NGINX Ingress Discovery" >> $GITHUB_STEP_SUMMARY
          
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          NGINX_INSTALLED="false"
          
          # Common NGINX ingress namespaces
          NGINX_NAMESPACES=("ingress-nginx" "nginx-ingress" "kube-system" "default")
          
          for NS in "${NGINX_NAMESPACES[@]}"; do
            if kubectl get deployment -n "$NS" 2>/dev/null | grep -q "ingress-nginx-controller\|nginx-ingress-controller"; then
              NGINX_INSTALLED="true"
              
              # Get controller details
              CONTROLLER=$(kubectl get deployment -n "$NS" -o name 2>/dev/null | grep -i nginx | head -1)
              if [ -n "$CONTROLLER" ]; then
                READY=$(kubectl get "$CONTROLLER" -n "$NS" -o jsonpath='{.status.readyReplicas}')
                DESIRED=$(kubectl get "$CONTROLLER" -n "$NS" -o jsonpath='{.spec.replicas}')
                
                echo "âœ… **NGINX Ingress Controller Found**" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                echo "| Namespace | \`${NS}\` |" >> $GITHUB_STEP_SUMMARY
                echo "| Controller | \`${CONTROLLER}\` |" >> $GITHUB_STEP_SUMMARY
                echo "| Status | \`${READY}/${DESIRED} Ready\` |" >> $GITHUB_STEP_SUMMARY
                
                # Check if metrics are exposed
                METRICS_SVC=$(kubectl get svc -n "$NS" 2>/dev/null | grep -i "controller-metrics\|prometheus" | head -1)
                if [ -n "$METRICS_SVC" ]; then
                  METRICS_PORT=$(kubectl get svc -n "$NS" -o jsonpath='{.items[?(@.metadata.name contains "metrics")].spec.ports[0].port}' 2>/dev/null | head -1)
                  echo "| Metrics | Exposed |" >> $GITHUB_STEP_SUMMARY
                fi
                
                break
              fi
            fi
          done
          
          if [ "$NGINX_INSTALLED" = "false" ]; then
            echo "âŒ **NGINX Ingress Controller NOT found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ To install NGINX Ingress:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx" >> $GITHUB_STEP_SUMMARY
            echo "helm repo update" >> $GITHUB_STEP_SUMMARY
            echo "helm install ingress-nginx ingress-nginx/ingress-nginx \\" >> $GITHUB_STEP_SUMMARY
            echo "  --namespace ingress-nginx --create-namespace \\" >> $GITHUB_STEP_SUMMARY
            echo "  --set controller.metrics.enabled=true" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "installed=${NGINX_INSTALLED}" >> $GITHUB_OUTPUT

      # ============================================
      # Validate Analysis Template Connectivity
      # ============================================
      - name: Validate Analysis Template
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª Analysis Template Validation" >> $GITHUB_STEP_SUMMARY
          
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          
          # Check current analysis template configuration
          CURRENT_PROM_URL=$(grep -oP 'address:\s*\K[^\s]+' .opsera-voting-app/k8s/base/rollouts/analysis-template.yaml | head -1 || echo "NOT_CONFIGURED")
          
          echo "### Current Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Configured Prometheus URL | \`${CURRENT_PROM_URL}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Discovered Prometheus URL | \`${{ steps.prometheus.outputs.url }}\` |" >> $GITHUB_STEP_SUMMARY
          
          # Check if URLs match
          if [ "$CURRENT_PROM_URL" = "${{ steps.prometheus.outputs.url }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Configuration matches discovered URL**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.prometheus.outputs.url }}" = "NOT_FOUND" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Prometheus not found - Analysis will fail without Prometheus**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consider using HTTP-based analysis instead (no Prometheus required)" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **URL mismatch - Analysis template may need update**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To update, set \`update_analysis_template: true\` and re-run this workflow" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # Update Analysis Template (Optional)
      # ============================================
      - name: Update Analysis Template
        if: ${{ github.event.inputs.update_analysis_template == 'true' && steps.prometheus.outputs.url != 'NOT_FOUND' }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”„ Updating Analysis Template" >> $GITHUB_STEP_SUMMARY
          
          PROMETHEUS_URL="${{ steps.prometheus.outputs.url }}"
          TEMPLATE_FILE=".opsera-voting-app/k8s/base/rollouts/analysis-template.yaml"
          
          # Update the prometheus address in the template
          sed -i "s|address:.*|address: ${PROMETHEUS_URL}|g" "$TEMPLATE_FILE"
          
          echo "âœ… Updated analysis template with: \`${PROMETHEUS_URL}\`" >> $GITHUB_STEP_SUMMARY
          
          # Show the change
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          grep -A 2 "provider:" "$TEMPLATE_FILE" | head -6 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Commit Analysis Template Update
        if: ${{ github.event.inputs.update_analysis_template == 'true' && steps.prometheus.outputs.url != 'NOT_FOUND' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add .opsera-voting-app/k8s/base/rollouts/analysis-template.yaml
            git commit -m "chore: update analysis template Prometheus URL [skip ci]"
            git push
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Changes committed and pushed**" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # Summary
      # ============================================
      - name: Generate Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Infrastructure Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | URL/Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          
          # Prometheus
          if [ "${{ steps.prometheus.outputs.url }}" != "NOT_FOUND" ]; then
            echo "| Prometheus | âœ… Found | \`${{ steps.prometheus.outputs.url }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Prometheus | âŒ Not Found | Install required for canary analysis |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ArgoCD
          if [ "${{ steps.argocd.outputs.url }}" != "NOT_FOUND" ]; then
            echo "| ArgoCD | âœ… Found | \`${{ steps.argocd.outputs.url }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ArgoCD | âŒ Not Found | Check hub cluster |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Argo Rollouts
          if [ "${{ steps.rollouts.outputs.installed }}" = "true" ]; then
            echo "| Argo Rollouts | âœ… Installed | Controller running |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Argo Rollouts | âŒ Not Installed | Required for canary deployments |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # NGINX
          if [ "${{ steps.nginx.outputs.installed }}" = "true" ]; then
            echo "| NGINX Ingress | âœ… Installed | Traffic splitting enabled |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| NGINX Ingress | âŒ Not Found | Required for canary traffic routing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Variables for CI/CD" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "export PROMETHEUS_URL=\"${{ steps.prometheus.outputs.url }}\"" >> $GITHUB_STEP_SUMMARY
          echo "export ARGOCD_URL=\"${{ steps.argocd.outputs.url }}\"" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
