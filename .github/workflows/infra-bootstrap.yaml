# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                      INFRASTRUCTURE: BOOTSTRAP                                â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”§ Infra: Bootstrap Environment"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - qa
        default: 'dev'

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  TENANT: opsera
  DOMAIN: agent.opsera.dev
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write
  id-token: write

jobs:
  verify:
    name: "ðŸ“‹ Verify Prerequisites"
    runs-on: ubuntu-latest
    outputs:
      subdomain: ${{ steps.subdomain.outputs.subdomain }}
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Generate Subdomain
        id: subdomain
        run: |
          ENV="${{ github.event.inputs.environment }}"
          if [ "$ENV" = "dev" ]; then
            SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}.${{ env.DOMAIN }}"
          else
            SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${ENV}.${{ env.DOMAIN }}"
          fi
          echo "subdomain=${SUBDOMAIN}" >> $GITHUB_OUTPUT
          echo "Subdomain: ${SUBDOMAIN}"

  setup-argocd:
    name: "ðŸ”„ Setup ArgoCD"
    runs-on: ubuntu-latest
    needs: [verify]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup ArgoCD Application
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl

          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

          ENV="${{ github.event.inputs.environment }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}.git"

          # Create repo secret if PAT exists
          if [ -n "$GH_PAT" ]; then
            ./kubectl create secret generic repo-${{ env.APP_NAME }} -n argocd \
              --from-literal=type=git \
              --from-literal=url="$REPO_URL" \
              --from-literal=password="$GH_PAT" \
              --from-literal=username="git" \
              --dry-run=client -o yaml | ./kubectl apply -f -

            ./kubectl label secret repo-${{ env.APP_NAME }} -n argocd \
              argocd.argoproj.io/secret-type=repository --overwrite
          fi

          # Apply ArgoCD application
          APP_FILE=".opsera-${{ env.APP_NAME }}/argocd/application-${ENV}.yaml"
          if [ -f "$APP_FILE" ]; then
            ./kubectl apply -f "$APP_FILE"
            echo "âœ… Applied ArgoCD application for ${ENV}"
          else
            echo "âš ï¸ Application manifest not found: ${APP_FILE}"
          fi

  summary:
    name: "ðŸ“ Summary"
    runs-on: ubuntu-latest
    needs: [verify, setup-argocd]
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ”§ Bootstrap Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Subdomain | ${{ needs.verify.outputs.subdomain }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run **ðŸ”¨ CI: Build Images**" >> $GITHUB_STEP_SUMMARY
          echo "2. Run **ðŸš€ CD: Deploy to DEV**" >> $GITHUB_STEP_SUMMARY
