# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                   SETUP: PROVISION GITHUB ENVIRONMENTS                        â•‘
# â•‘                                                                                â•‘
# â•‘  This workflow provisions GitHub environments for approval gates.             â•‘
# â•‘  Run once to set up environments, or when adding new approvers.               â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "âš™ï¸ Setup: Provision Environments"

on:
  workflow_dispatch:
    inputs:
      approvers:
        description: 'Comma-separated GitHub usernames for approvers'
        required: true
        default: 'srinivasperi'
        type: string
      recreate:
        description: 'Delete and recreate environments'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  provision:
    name: "âš™ï¸ Provision Environments"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment - qa-approval
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          ENV_NAME="qa-approval"
          APPROVERS="${{ github.event.inputs.approvers }}"
          
          echo "## âš™ï¸ GitHub Environment Provisioning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Delete if recreate is requested
          if [ "${{ github.event.inputs.recreate }}" = "true" ]; then
            echo "Deleting existing environment..."
            gh api --method DELETE "repos/${REPO}/environments/${ENV_NAME}" 2>/dev/null || true
            sleep 2
          fi
          
          # Get user IDs for approvers
          REVIEWER_IDS=""
          IFS=',' read -ra APPROVER_ARRAY <<< "$APPROVERS"
          
          echo "### Approvers" >> $GITHUB_STEP_SUMMARY
          echo "| Username | User ID | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for APPROVER in "${APPROVER_ARRAY[@]}"; do
            APPROVER=$(echo "$APPROVER" | xargs)  # Trim whitespace
            USER_ID=$(gh api "users/${APPROVER}" --jq '.id' 2>/dev/null || echo "")
            
            if [ -n "$USER_ID" ]; then
              echo "| @${APPROVER} | ${USER_ID} | âœ… Found |" >> $GITHUB_STEP_SUMMARY
              if [ -n "$REVIEWER_IDS" ]; then
                REVIEWER_IDS="${REVIEWER_IDS},{\"type\":\"User\",\"id\":${USER_ID}}"
              else
                REVIEWER_IDS="{\"type\":\"User\",\"id\":${USER_ID}}"
              fi
            else
              echo "| @${APPROVER} | - | âŒ Not found |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ -z "$REVIEWER_IDS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Error:** No valid approvers found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Create/update environment with protection rules
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Configuration" >> $GITHUB_STEP_SUMMARY
          
          gh api --method PUT "repos/${REPO}/environments/${ENV_NAME}" \
            -f wait_timer=0 \
            -f prevent_self_review=false \
            --input - << EOF
          {
            "deployment_branch_policy": null,
            "reviewers": [${REVIEWER_IDS}]
          }
          EOF
          
          if [ $? -eq 0 ]; then
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Environment** | \`${ENV_NAME}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Status** | âœ… Created/Updated |" >> $GITHUB_STEP_SUMMARY
            echo "| **Approvers** | ${APPROVERS} |" >> $GITHUB_STEP_SUMMARY
            echo "| **URL** | [View Environment](https://github.com/${REPO}/settings/environments) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Error:** Failed to create environment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You may need to create it manually:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to **Settings** â†’ **Environments**" >> $GITHUB_STEP_SUMMARY
            echo "2. Click **New environment**" >> $GITHUB_STEP_SUMMARY
            echo "3. Name: \`qa-approval\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Add required reviewers: ${APPROVERS}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Run **ðŸ”¨ CI: Build Images** to build new images" >> $GITHUB_STEP_SUMMARY
          echo "2. Run **ðŸš€ CD: Deploy to DEV** to deploy to DEV" >> $GITHUB_STEP_SUMMARY
          echo "3. Run **â¬†ï¸ CD: Promote DEV â†’ QA** to trigger approval workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "When you run the QA promotion, you'll receive:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“§ Email notification from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¬ Slack message (if webhook configured)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”” GitHub notification" >> $GITHUB_STEP_SUMMARY
