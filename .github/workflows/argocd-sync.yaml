name: "ArgoCD - Force Sync Application"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'dev'
      sync_type:
        description: 'Sync type'
        required: true
        type: choice
        options:
          - refresh-and-sync
          - hard-refresh
          - sync-only
        default: 'refresh-and-sync'

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  HUB_CLUSTER: argocd-usw2

permissions:
  contents: read
  id-token: write

jobs:
  argocd-sync:
    name: "ArgoCD Sync"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          # Install argocd CLI
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Connect to Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          kubectl cluster-info

      - name: Get ArgoCD Admin Password
        id: argocd-creds
        run: |
          ARGOCD_PWD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" 2>/dev/null | base64 -d || echo "")

          if [ -z "$ARGOCD_PWD" ]; then
            echo "ArgoCD admin secret not found. Using kubectl for sync."
            echo "use_kubectl=true" >> $GITHUB_OUTPUT
          else
            echo "use_kubectl=false" >> $GITHUB_OUTPUT
            echo "::add-mask::$ARGOCD_PWD"
            echo "password=$ARGOCD_PWD" >> $GITHUB_OUTPUT
          fi

      - name: ArgoCD Login
        if: steps.argocd-creds.outputs.use_kubectl == 'false'
        run: |
          # Get ArgoCD server
          ARGOCD_SERVER=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")

          if [ -z "$ARGOCD_SERVER" ]; then
            # Try port-forward in background
            kubectl port-forward svc/argocd-server -n argocd 8080:443 &
            sleep 5
            ARGOCD_SERVER="localhost:8080"
          fi

          argocd login "$ARGOCD_SERVER" --username admin --password "${{ steps.argocd-creds.outputs.password }}" --insecure || true

      - name: Show Current State
        run: |
          APP_NAME="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "## Current State" >> $GITHUB_STEP_SUMMARY

          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application "${APP_NAME}" -n argocd -o jsonpath='Sync: {.status.sync.status}
Health: {.status.health.status}
Revision: {.status.sync.revision}
' 2>/dev/null || echo "App not found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Hard Refresh (Clear Cache)
        if: ${{ github.event.inputs.sync_type == 'hard-refresh' || github.event.inputs.sync_type == 'refresh-and-sync' }}
        run: |
          APP_NAME="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "### Hard Refresh" >> $GITHUB_STEP_SUMMARY

          # Patch to trigger hard refresh
          kubectl patch application "${APP_NAME}" -n argocd \
            --type=merge \
            -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'

          echo "Triggered hard refresh for ${APP_NAME}" >> $GITHUB_STEP_SUMMARY

          # Wait for refresh
          sleep 10

      - name: Force Sync
        if: ${{ github.event.inputs.sync_type == 'sync-only' || github.event.inputs.sync_type == 'refresh-and-sync' }}
        run: |
          APP_NAME="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "### Force Sync" >> $GITHUB_STEP_SUMMARY

          # Trigger sync via annotation
          kubectl patch application "${APP_NAME}" -n argocd \
            --type=merge \
            -p "{\"operation\":{\"initiatedBy\":{\"username\":\"github-actions\"},\"sync\":{\"prune\":true}}}"

          echo "Triggered sync for ${APP_NAME}" >> $GITHUB_STEP_SUMMARY

      - name: Wait for Sync
        run: |
          APP_NAME="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "### Sync Progress" >> $GITHUB_STEP_SUMMARY

          MAX_ATTEMPTS=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            SYNC_STATUS=$(kubectl get application "${APP_NAME}" -n argocd \
              -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")

            HEALTH_STATUS=$(kubectl get application "${APP_NAME}" -n argocd \
              -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")

            OPERATION_PHASE=$(kubectl get application "${APP_NAME}" -n argocd \
              -o jsonpath='{.status.operationState.phase}' 2>/dev/null || echo "None")

            echo "[$ATTEMPT/$MAX_ATTEMPTS] Sync: ${SYNC_STATUS}, Health: ${HEALTH_STATUS}, Operation: ${OPERATION_PHASE}"

            if [ "$SYNC_STATUS" = "Synced" ] && [ "$OPERATION_PHASE" != "Running" ]; then
              echo "Sync complete!" >> $GITHUB_STEP_SUMMARY
              break
            fi

            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Final Status:" >> $GITHUB_STEP_SUMMARY
          echo "  Sync: ${SYNC_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "  Health: ${HEALTH_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Show Final State
        run: |
          APP_NAME="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "## Final State" >> $GITHUB_STEP_SUMMARY

          echo "### Application" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application "${APP_NAME}" -n argocd \
            -o jsonpath='Sync: {.status.sync.status}
Health: {.status.health.status}
Revision: {.status.sync.revision}
'
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application "${APP_NAME}" -n argocd \
            -o jsonpath='{range .status.resources[*]}{.kind}/{.name}: {.status} ({.health.status}){"\n"}{end}' || true
          echo '```' >> $GITHUB_STEP_SUMMARY
