name: "Test Canary Deployment"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
      service:
        description: 'Service to test canary'
        required: true
        default: 'vote'
        type: choice
        options:
          - vote
          - result
      trigger_method:
        description: 'How to trigger the canary'
        required: true
        default: 'restart'
        type: choice
        options:
          - restart
          - promote
      generate_traffic:
        description: 'Generate traffic during canary'
        required: false
        default: 'true'
        type: boolean
      monitor_duration:
        description: 'Monitor duration in seconds'
        required: true
        default: '300'
        type: string

env:
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  APP_NAME: voting-app

permissions:
  contents: read
  id-token: write

jobs:
  test-canary:
    name: "Test Canary - ${{ github.event.inputs.service }}"
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          
          curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
          
          # Install hey for traffic generation
          wget -q https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
          chmod +x hey_linux_amd64
          sudo mv hey_linux_amd64 /usr/local/bin/hey

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Initialize Report
        run: |
          echo "## Canary Deployment Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | ${{ github.event.inputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event.inputs.trigger_method }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Traffic | ${{ github.event.inputs.generate_traffic }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check Initial State
        run: |
          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          ROLLOUT="${{ github.event.inputs.service }}-rollout"
          
          echo "### Initial Rollout State" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PHASE=$(kubectl get rollout "$ROLLOUT" -n "$NAMESPACE" -o jsonpath='{.status.phase}')
          REPLICAS=$(kubectl get rollout "$ROLLOUT" -n "$NAMESPACE" -o jsonpath='{.status.replicas}')
          READY=$(kubectl get rollout "$ROLLOUT" -n "$NAMESPACE" -o jsonpath='{.status.readyReplicas}')
          
          echo "- Phase: **$PHASE**" >> $GITHUB_STEP_SUMMARY
          echo "- Replicas: $READY/$REPLICAS ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Canary
        id: trigger
        run: |
          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          ROLLOUT="${{ github.event.inputs.service }}-rollout"
          METHOD="${{ github.event.inputs.trigger_method }}"
          
          echo "### Triggering Canary ($METHOD)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$METHOD" = "restart" ]; then
            kubectl-argo-rollouts restart "$ROLLOUT" -n "$NAMESPACE"
            echo "âœ… Rollout restart initiated" >> $GITHUB_STEP_SUMMARY
          else
            # Promote to next step
            kubectl-argo-rollouts promote "$ROLLOUT" -n "$NAMESPACE"
            echo "âœ… Rollout promoted to next step" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Record start time
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Start Background Traffic
        if: ${{ github.event.inputs.generate_traffic == 'true' }}
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          ENV="${{ github.event.inputs.environment }}"
          DURATION="${{ github.event.inputs.monitor_duration }}"
          
          case "$ENV" in
            qa)
              VOTE_URL="https://opsera-voting-app-qa.agent.opsera.dev"
              RESULT_URL="https://results.opsera-voting-app-qa.agent.opsera.dev"
              ;;
            *)
              VOTE_URL="https://opsera-voting-app-${ENV}.agent.opsera.dev"
              RESULT_URL="https://results.opsera-voting-app-${ENV}.agent.opsera.dev"
              ;;
          esac
          
          if [ "$SERVICE" = "vote" ]; then
            URL="$VOTE_URL"
          else
            URL="$RESULT_URL"
          fi
          
          RPS=5
          TOTAL=$((DURATION * RPS))
          
          echo "### Background Traffic" >> $GITHUB_STEP_SUMMARY
          echo "Starting traffic generator: $RPS RPS to $URL for ${DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run traffic in background
          nohup hey -n $TOTAL -c 5 -q $RPS "$URL" > /tmp/traffic_results.txt 2>&1 &
          echo $! > /tmp/traffic_pid.txt

      - name: Monitor Canary Progress
        run: |
          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          ROLLOUT="${{ github.event.inputs.service }}-rollout"
          DURATION="${{ github.event.inputs.monitor_duration }}"
          
          echo "### Canary Progress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Time | Phase | Step | Weight | Ready |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          START=$(date +%s)
          INTERVAL=30
          LAST_PHASE=""
          LAST_STEP=""
          
          while true; do
            NOW=$(date +%s)
            ELAPSED=$((NOW - START))
            
            if [ $ELAPSED -ge $DURATION ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Monitoring duration reached." >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            # Get current status
            STATUS=$(kubectl get rollout "$ROLLOUT" -n "$NAMESPACE" -o json)
            PHASE=$(echo "$STATUS" | jq -r '.status.phase')
            STEP=$(echo "$STATUS" | jq -r '.status.currentStepIndex // 0')
            TOTAL_STEPS=$(echo "$STATUS" | jq -r '.spec.strategy.canary.steps | length')
            WEIGHT=$(kubectl get rollout "$ROLLOUT" -n "$NAMESPACE" -o jsonpath='{.status.canary.weights.canary}' 2>/dev/null || echo "0")
            READY=$(echo "$STATUS" | jq -r '.status.readyReplicas // 0')
            REPLICAS=$(echo "$STATUS" | jq -r '.status.replicas // 0')
            
            # Get emoji
            case "$PHASE" in
              "Healthy") EMOJI="ðŸŸ¢" ;;
              "Progressing") EMOJI="ðŸ”µ" ;;
              "Paused") EMOJI="â¸ï¸" ;;
              "Degraded") EMOJI="ðŸ”´" ;;
              *) EMOJI="âšª" ;;
            esac
            
            # Log if phase or step changed
            if [ "$PHASE" != "$LAST_PHASE" ] || [ "$STEP" != "$LAST_STEP" ]; then
              TIME_STR=$(date -d "@$NOW" +"%H:%M:%S" 2>/dev/null || date -r $NOW +"%H:%M:%S")
              echo "| ${TIME_STR} | ${EMOJI} ${PHASE} | ${STEP}/${TOTAL_STEPS} | ${WEIGHT}% | ${READY}/${REPLICAS} |" >> $GITHUB_STEP_SUMMARY
              LAST_PHASE="$PHASE"
              LAST_STEP="$STEP"
            fi
            
            # Check if rollout is complete or failed
            if [ "$PHASE" = "Healthy" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Canary completed successfully!**" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            if [ "$PHASE" = "Degraded" ]; then
              MESSAGE=$(echo "$STATUS" | jq -r '.status.message')
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **Canary failed!** Message: $MESSAGE" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            sleep $INTERVAL
          done

      - name: Collect Traffic Results
        if: ${{ github.event.inputs.generate_traffic == 'true' }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Traffic Results" >> $GITHUB_STEP_SUMMARY
          
          # Wait for traffic to finish
          if [ -f /tmp/traffic_pid.txt ]; then
            PID=$(cat /tmp/traffic_pid.txt)
            wait $PID 2>/dev/null || true
          fi
          
          if [ -f /tmp/traffic_results.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/traffic_results.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "No traffic results available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Final State
        run: |
          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          ROLLOUT="${{ github.event.inputs.service }}-rollout"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Final State" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl-argo-rollouts get rollout "$ROLLOUT" -n "$NAMESPACE" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n "$NAMESPACE" -l app=${{ github.event.inputs.service }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
