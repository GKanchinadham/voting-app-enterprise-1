name: "Configure Prometheus NGINX Metrics"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - configure

env:
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: read
  id-token: write

jobs:
  configure-prometheus:
    name: "Configure Prometheus NGINX Metrics"
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Check NGINX Ingress Controller Metrics
        run: |
          echo "## NGINX Ingress Metrics Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find NGINX Ingress controller
          echo "### NGINX Ingress Controller" >> $GITHUB_STEP_SUMMARY
          NGINX_NS=$(kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].metadata.namespace}' 2>/dev/null || echo "")
          
          if [ -z "$NGINX_NS" ]; then
            echo "❌ NGINX Ingress controller not found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "- Namespace: \`$NGINX_NS\`" >> $GITHUB_STEP_SUMMARY
          
          # Get controller pod
          NGINX_POD=$(kubectl get pods -n "$NGINX_NS" -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].metadata.name}')
          echo "- Pod: \`$NGINX_POD\`" >> $GITHUB_STEP_SUMMARY
          
          # Check if metrics are enabled
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metrics Configuration" >> $GITHUB_STEP_SUMMARY
          
          # Check for metrics port
          METRICS_PORT=$(kubectl get svc -n "$NGINX_NS" -l app.kubernetes.io/name=ingress-nginx -o json | jq -r '.items[].spec.ports[] | select(.name=="metrics" or .name=="prometheus") | .port' | head -1)
          
          if [ -n "$METRICS_PORT" ]; then
            echo "✅ Metrics port found: $METRICS_PORT" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Dedicated metrics port not found (may use main port)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for ServiceMonitor
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ServiceMonitor Status" >> $GITHUB_STEP_SUMMARY
          
          SM_EXISTS=$(kubectl get servicemonitor -n "$NGINX_NS" -l app.kubernetes.io/name=ingress-nginx 2>/dev/null | grep -v "No resources" || echo "")
          if [ -n "$SM_EXISTS" ]; then
            echo "✅ ServiceMonitor exists:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            kubectl get servicemonitor -n "$NGINX_NS" -l app.kubernetes.io/name=ingress-nginx >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            # Check in monitoring namespace
            SM_MON=$(kubectl get servicemonitor -n monitoring -o name 2>/dev/null | grep -i nginx || echo "")
            if [ -n "$SM_MON" ]; then
              echo "✅ ServiceMonitor found in monitoring namespace:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              kubectl get servicemonitor -n monitoring -o name | grep -i nginx >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ No ServiceMonitor found - metrics won't be scraped by Prometheus" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Test Prometheus Query
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Prometheus Query Test" >> $GITHUB_STEP_SUMMARY
          
          # Get Prometheus pod
          PROM_POD=$(kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          
          if [ -z "$PROM_POD" ]; then
            echo "❌ Prometheus pod not found!" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "Testing query: \`nginx_ingress_controller_requests\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Query Prometheus for nginx metrics
          RESULT=$(kubectl exec -n monitoring "$PROM_POD" -c prometheus -- wget -qO- "http://localhost:9090/api/v1/query?query=count(nginx_ingress_controller_requests)" 2>/dev/null || echo '{"status":"error"}')
          
          STATUS=$(echo "$RESULT" | jq -r '.status')
          
          if [ "$STATUS" = "success" ]; then
            COUNT=$(echo "$RESULT" | jq -r '.data.result[0].value[1] // "0"')
            if [ "$COUNT" != "0" ] && [ "$COUNT" != "null" ]; then
              echo "✅ **nginx_ingress_controller_requests metric is available!**" >> $GITHUB_STEP_SUMMARY
              echo "- Sample count: $COUNT time series" >> $GITHUB_STEP_SUMMARY
              
              # Get some sample labels
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Sample metric labels:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              kubectl exec -n monitoring "$PROM_POD" -c prometheus -- wget -qO- "http://localhost:9090/api/v1/query?query=nginx_ingress_controller_requests" 2>/dev/null | jq -r '.data.result[0].metric | to_entries | .[] | "\(.key): \(.value)"' | head -10 >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **nginx_ingress_controller_requests metric NOT found**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Need to enable NGINX Ingress metrics scraping." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Query failed - Prometheus may not be accessible" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check what metrics ARE available from nginx
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available NGINX Metrics" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl exec -n monitoring "$PROM_POD" -c prometheus -- wget -qO- "http://localhost:9090/api/v1/label/__name__/values" 2>/dev/null | jq -r '.data[]' | grep -i nginx | head -20 >> $GITHUB_STEP_SUMMARY || echo "No nginx metrics found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Configure ServiceMonitor
        if: ${{ github.event.inputs.action == 'configure' }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Creating ServiceMonitor" >> $GITHUB_STEP_SUMMARY
          
          # Find NGINX namespace
          NGINX_NS=$(kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].metadata.namespace}' 2>/dev/null || echo "ingress-nginx")
          
          cat <<EOF | kubectl apply -f -
          apiVersion: monitoring.coreos.com/v1
          kind: ServiceMonitor
          metadata:
            name: nginx-ingress-controller
            namespace: monitoring
            labels:
              app.kubernetes.io/name: ingress-nginx
              release: prometheus
          spec:
            jobLabel: app.kubernetes.io/name
            namespaceSelector:
              matchNames:
              - ${NGINX_NS}
            selector:
              matchLabels:
                app.kubernetes.io/name: ingress-nginx
                app.kubernetes.io/component: controller
            endpoints:
            - port: metrics
              interval: 15s
              path: /metrics
          EOF
          
          echo "✅ ServiceMonitor created in monitoring namespace" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Prometheus will start scraping within 1-2 minutes." >> $GITHUB_STEP_SUMMARY
          echo "Re-run this workflow with 'check' action to verify." >> $GITHUB_STEP_SUMMARY
